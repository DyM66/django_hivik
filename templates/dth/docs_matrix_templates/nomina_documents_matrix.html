{# dth/templates/dth/nomina_documents_matrix.html #}
{% extends "base/base_generic.html" %}

{% block title %}Matriz de Documentos{% endblock %}

{% block headtag %}

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeo0+KxKIY6jnr953No1M6Jg25Jd/hmO3Qmo7G8k3R0Nu8Ix"
      crossorigin="anonymous">
<style>
:root {
    --color-primary: #191645;
    --color-aux: #0157a4;
    --color-secondary: #43C6AC;
    --color-bg: #ffffff;
    --color-bg-aux: #D5DBDB;

    --color-orange: #d78147;
    --color-yellow: #f5da81;
    --color-red: #d893a3;
    --color-blue: #6fcaea;
    --color-violet: #6f79ea;
    --color-green: #86e49d;

    /* Más variables si deseas */
}

/* .table-scroll-container {
	width: 100%;                 
	max-height: 70vh;      
	overflow-x: auto;        
	overflow-y: auto;
	
 */
	/* overscroll-behavior-x: none; */
/* 
	overscroll-behavior-y: contain;
	
	-webkit-overflow-scrolling: touch; 
	touch-action: pan-x pan-y;        
}
.table {
	width: 100%; 
	table-layout: auto;
	white-space: nowrap;
} */
/* Encabezado sticky (fila superior) */
/* .table thead th {
	position: sticky;
	top: 0;
	background-color: #fff;
	z-index: 10;
} */
table .sticky-col1 {
	position: sticky;
	left: 0;                  
	background: #fff;
	z-index: 11;              
	min-width: 150px;        
	white-space: nowrap;       
}
table .sticky-col2 {
	position: sticky;
	left: 150px;           
	background: #fff;
	z-index: 11;
	min-width: 130px;       
	white-space: nowrap;
} 
/* Sombra sutil para las columnas fijas 

/* 
html, body {
  overscroll-behavior: none;
/* } 
*/
.sticky-col1, .sticky-col2 {
  	box-shadow: 1px 0 5px rgba(0,0,0,0.1);
}
.table tbody td {
  white-space: nowrap;
}

/* Unas clases de badge personalizadas (además de “badge” de Bootstrap) */
.badge {
  display: inline-block;
  padding: 0.35em 0.6em;
  font-size: 0.8em;
  font-weight: 600;
  border-radius: 0.4rem;
  text-align: center;
  vertical-align: middle;
  white-space: nowrap;
}

/* Ejemplo de colores para cada estado */
.badge-pendiente { background-color: var(--color-orange); color: #fff; }
.badge-vencido   { background-color: var(--color-red);    color: #fff; }
.badge-ok        { background-color: var(--color-green);  color: #000; }
/* etc. */

</style>
{% endblock %}

{% block content %}

	<h2>Matriz de Documentos</h2>

	<!-- Buscador para filtrar por cédula, nombre completo o cargo -->
	<div class="row mb-3">
		<div class="col-md-6">
			<input type="text" id="searchNomina" class="form-control" placeholder="Buscar por cédula, nombre o cargo...">
		</div>
	</div>

  	<div class="" style="overflow-x:auto;">
    	<table class="table table-bordered table-sm">
      		<thead>
				<tr>
					<th class="sticky-col1">Nombre</th>
					<th class="sticky-col2">Cargo</th>
					<th>Cédula</th>
					<th></th>
					{% for doc in docs %}
						<th>{{ doc.name }}</th>
					{% endfor %}
				</tr>
			</thead>
			<tbody id="nominaMatrixBody">
				{% for row in rows %}
				<tr>
					<!-- cédula, nombre, cargo -->
					<td class="sticky-col1">
						{{ row.employee.name }} {{ row.employee.surname }}
					</td>
					<td class="sticky-col2">{{ row.employee.position_id }}</td>
					<td>{{ row.employee.id_number }}</td>
					<td>
						<a class="btn btn-sm btn-secondary" href="{% url 'dth:request_docs_form' row.employee.id %}">
							Solicitar
						</a>
					</td>

					{% for cell in row.cells %}
						{% if cell.state == "N/A" %}
							<!-- No badge, solo text-muted -->
							<td class="text-muted">N/A</td>
						{% elif cell.state == "Pendiente" %}
							{% if cell.highlight %}
							<td>
								<span class="badge badge-pendiente {% if cell.highlight %}fw-bold{% else %}opacity-75{% endif %}"
									style="cursor:pointer;" onclick="openDocForm('{{ cell.employee_id }}','{{ cell.document_id }}')">
									Pendiente
								</span>
							</td>
						{% else %}
							<td><span class="badge badge-pendiente" style="opacity:0.7">Pendiente</span></td>
						{% endif %}
            {% elif cell.state == "Vencido" %}
                <td>
                    <span class="badge badge-vencido"
                        style="cursor:pointer;"
                        onclick="openDocForm('{{ cell.employee_id }}','{{ cell.document_id }}')">
                        Vencido
                    </span>
                </td>
            {% elif cell.is_ok %}
            <td>
                <span class="badge badge-ok"
                      style="cursor:pointer;"
                      onclick="openDocPreview('{{ cell.employee_id }}','{{ cell.document_id }}')">
                  {{ cell.state }}
                </span>
            </td>
            {% else %}
              <!-- Por si hay otro estado no contemplado -->
              <td>{{ cell.state }}</td>
            {% endif %}
          {% endfor %}
        </tr>
        {% endfor %}
      	</tbody>
    	</table>
  	</div>


<!-- Modal SUBIR DOC -->
<div class="modal fade" id="modalUploadDoc" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" id="modalUploadDocContent">
        <!-- Aquí se inyecta partial form -->
      </div>
    </div>
  </div>
  
  <!-- Modal PREVIEW DOC -->
  <div class="modal fade" id="modalPreviewDoc" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="modalPreviewDocContent">
        <!-- Aquí se inyecta la lista de docs subidos -->
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalRequestDocs" tabindex="-1">
	<div class="modal-dialog">
	  <div class="modal-content" id="modalRequestDocsContent">
		<!-- Aquí llega el HTML AJAX -->
	  </div>
	</div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-pp4C9WpCUvKXbxkKBlbp9f9uwc5LCG986ppCrYi7PFmk4fi8BW3ZkGf7PZwjw7Bt"
  crossorigin="anonymous"></script>


<script>
//-------------------------------------------------------
// 1) Filtro para buscar por cédula, nombre o cargo
//-------------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
const searchInput = document.getElementById('searchNomina');
const tableBody = document.getElementById('nominaMatrixBody');

if (searchInput && tableBody) {
searchInput.addEventListener('keyup', () => {
const filter = searchInput.value.toLowerCase();
const rows = tableBody.querySelectorAll('tr');

rows.forEach(row => {
  const tds = row.querySelectorAll('td');
  if (tds.length < 3) return;

  const cedula = tds[0].innerText.toLowerCase();
  const nombre = tds[1].innerText.toLowerCase();
  const cargo  = tds[2].innerText.toLowerCase();

  if (cedula.includes(filter) || nombre.includes(filter) || cargo.includes(filter)){
	row.style.display = '';
  } else {
	row.style.display = 'none';
  }
});
});
}
});

//-------------------------------------------------------
// 2) Scroll container => prevenir swipe-back en iOS
//-------------------------------------------------------
// document.addEventListener('DOMContentLoaded', function(){
//     const container = document.querySelector('.table-scroll-container');
//     if (container) {
//         container.addEventListener('wheel', function(e) {
//             // deltaX > 0 => el usuario está desplazándose a la derecha
//             // deltaX < 0 => el usuario está desplazándose a la izquierda

//             const maxScrollLeft = container.scrollWidth - container.clientWidth;

//             // Límite izquierdo
//             if (e.deltaX < 0 && container.scrollLeft <= 0) {
//                 e.preventDefault();
//             }
//             // Límite derecho
//             else if (e.deltaX > 0 && container.scrollLeft >= maxScrollLeft) {
//                 e.preventDefault();
//             }
//             // En caso contrario, no prevenimos => scroll normal
//         }, { passive: false });
//     }
// });


//-------------------------------------------------------
// 3) Abrir form para subir doc (Pendiente/Vencido)
//-------------------------------------------------------
function openDocForm(empId, docId) {
fetch("{% url 'dth:employee_document_form' %}?emp=" + empId + "&doc=" + docId, {
headers: {'X-Requested-With': 'XMLHttpRequest'}
})
.then(res => res.text())
.then(html => {
const modalContent = document.getElementById('modalUploadDocContent');
modalContent.innerHTML = html;

const myModal = new bootstrap.Modal(document.getElementById('modalUploadDoc'));
myModal.show();

// Manejar el submit del form
const form = modalContent.querySelector('#employee-document-form');
if (form) {
form.addEventListener('submit', e => {
  e.preventDefault();
  uploadDocument(form);
});
}
})
.catch(err => alert("Error abriendo doc form: " + err));
}

function uploadDocument(form) {
const formData = new FormData(form);
fetch("{% url 'dth:create_employee_document' %}", {
method: 'POST',
headers: {'X-Requested-With': 'XMLHttpRequest'},
body: formData
})
.then(res => res.json())
.then(data => {
if (data.success) {
const myModal = bootstrap.Modal.getInstance(document.getElementById('modalUploadDoc'));
myModal.hide();
location.reload();
} else {
alert(data.message || "Error al subir documento");
}
})
.catch(err => alert("Error uploadDocument: " + err));
}

//-------------------------------------------------------
// 4) Abrir preview de doc (Ok)
//-------------------------------------------------------
function openDocPreview(empId, docId) {
fetch("{% url 'dth:employee_document_preview' %}?emp=" + empId + "&doc=" + docId, {
headers: {'X-Requested-With': 'XMLHttpRequest'}
})
.then(res => res.text())
.then(html => {
const modalContent = document.getElementById('modalPreviewDocContent');
modalContent.innerHTML = html;

const previewModal = new bootstrap.Modal(document.getElementById('modalPreviewDoc'));
previewModal.show();
})
.catch(err => alert("Error openDocPreview: " + err));
}

//-------------------------------------------------------
// 5) Eliminar un EmployeeDocument
//-------------------------------------------------------
function deleteEmployeeDocument(employeeDocId) {
if (!confirm("¿Seguro que deseas eliminar este archivo?")) return;
const fd = new FormData();
fd.append('employee_doc_id', employeeDocId);

fetch("{% url 'dth:delete_employee_document' %}", {
method: 'POST',
headers: {
'X-Requested-With': 'XMLHttpRequest',
'X-CSRFToken': '{{ csrf_token }}'
},
body: fd
})
.then(res => res.json())
.then(data => {
if (data.success) {
alert(data.message);
location.reload();
} else {
alert("Error al eliminar: " + data.message);
}
})
.catch(err => alert("Error deleteEmployeeDocument: " + err));
}
</script>
  
{% endblock %}
