{% extends 'base/base_generic.html' %}

{% block content %}
<div class="container my-4">
    <h2>Crear Reporte de Horas Extras</h2>

    <form method="post" id="overtimeForm">{% csrf_token %}
        {{ form.report_date.label_tag }} {{ form.report_date }}
        <br>
        {{ form.description.label_tag }} {{ form.description }}
        <br>
        
        {% if form.asset %}
            {{ form.asset.label_tag }} {{ form.asset }}
            <br>
        {% endif %}

        {{ form.start.label_tag }} {{ form.start }}
        <br>
        {{ form.end.label_tag }} {{ form.end }}
        <br>

        <button type="button" id="addPersonBtn" class="btn btn-secondary">Agregar Persona</button>

        <div id="personList" class="mt-3"></div>

        <!-- Campos ocultos para almacenar datos generados por JavaScript -->
        {{ form.cedulas }}
        {{ form.personas_externas }}

        <button type="submit" class="btn btn-primary mt-3">Enviar Reporte</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addPersonBtn = document.getElementById('addPersonBtn');
        const personList = document.getElementById('personList');
        const cedulasInput = document.getElementById('id_cedulas');
        const externosInput = document.getElementById('id_personas_externas');
    
        let cedulasArray = [];
        let externosArray = [];
    
        addPersonBtn.onclick = function() {
            const personDiv = document.createElement('div');
            personDiv.className = 'input-group my-3';
    
            personDiv.innerHTML = `
                <input type="text" class="form-control cedula-input" placeholder="Cédula">
                <button class="btn btn-outline-secondary buscar-btn" type="button">Buscar</button>
                <div class="result-section w-100 mt-2"></div>
            `;
    
            personList.appendChild(personDiv);
    
            const buscarBtn = personDiv.querySelector('.buscar-btn');
            const cedulaInput = personDiv.querySelector('.cedula-input');
            const resultSection = personDiv.querySelector('.result-section');
    
            buscarBtn.onclick = function() {
                const cedula = cedulaInput.value.trim();
    
                if (!cedula) {
                    resultSection.innerHTML = '<div class="alert alert-warning">Ingresa una cédula válida.</div>';
                    return;
                }
    
                fetch(`{% url 'dth:buscar_nomina' %}?cedula=${cedula}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            if (cedulasArray.includes(cedula)) {
                                resultSection.innerHTML = `<div class="alert alert-info">Persona ya agregada: ${data.name} (${data.position})</div>`;
                            } else {
                                resultSection.innerHTML = `<div class="alert alert-success">Encontrado: ${data.name} (${data.position})</div>`;
                                cedulasArray.push(cedula);
                                cedulasInput.value = JSON.stringify(cedulasArray);
                            }
                        } else {
                            resultSection.innerHTML = `
                                <div class="alert alert-danger">
                                    Persona no registrada. 
                                    <button class="btn btn-sm btn-link registrar-manual">Registrar manualmente</button>
                                </div>
                            `;
                            const registrarManualBtn = resultSection.querySelector('.registrar-manual');
                            registrarManualBtn.onclick = function() {
                                mostrarFormularioManual(cedula, resultSection);
                                registrarManualBtn.disabled = true;
                            };
                        }
                    })
                    .catch(() => {
                        resultSection.innerHTML = '<div class="alert alert-danger">Error al realizar la búsqueda.</div>';
                    });
            };
        };
    
        function mostrarFormularioManual(cedula, container) {
            const formManual = document.createElement('div');
            formManual.className = 'card p-3 mt-2 bg-light';
    
            formManual.innerHTML = `
                <div class="mb-2">
                    <label>Nombre Completo</label>
                    <input type="text" class="form-control nombre-completo">
                </div>
                <div class="mb-2">
                    <label>Cargo</label>
                    <select class="form-select cargo">
                        <option value="">Selecciona un cargo</option>
                        <option value="a">Capitán</option>
                        <option value="b">Primer Oficial de Puente</option>
                        <option value="c">Marino</option>
                        <option value="d">Jefe de Máquinas</option>
                        <option value="e">Primer Oficial de Máquinas</option>
                        <option value="f">Maquinista</option>
                        <option value="g">Otro</option>
                    </select>
                </div>
                <button type="button" class="btn btn-success agregar-externo">Agregar</button>
            `;
    
            container.appendChild(formManual);
    
            formManual.querySelector('.agregar-externo').onclick = function() {
                const nombre = formManual.querySelector('.nombre-completo').value.trim();
                const cargo = formManual.querySelector('.cargo').value;
    
                if (!nombre || !cargo) {
                    alert('Por favor completa todos los campos.');
                    return;
                }
    
                externosArray.push({ nombre_completo: nombre, cedula: cedula, cargo: cargo });
                externosInput.value = JSON.stringify(externosArray);
    
                formManual.innerHTML = `
                    <div class="alert alert-success">
                        Agregado: ${nombre} (Cargo: ${formManual.querySelector('.cargo option:checked').textContent})
                    </div>
                `;
            };
        }
    });
    </script>
    
    
{% endblock %}
