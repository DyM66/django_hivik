{% extends "got/base/base_generic.html" %}
{% load my_tags %}
{% load con_extras %}
{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center">
        <a href="{% url 'cont:asset-list' %}"><i class="bi bi-arrow-bar-left"></i></a>
        <h1 class="mb-0">Detalle - {{ asset_cost.asset.name }}</h1>
        <!-- Botón discreto con el ícono de lápiz -->
        <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#updateModal">
            <i class="bi bi-pencil" style="font-size: 1rem; color: #094067;"></i>
        </button>
    </div>

    <!-- Sección de Depreciación -->
    <div class="my-4">
        <h2 class="h4 text-primary border-bottom pb-2">Depreciación (10 años)</h2>
        <p>Total (Costo Inicial + Inversión): <span id="totalCostDisplay">{{ total_cost|currency }}</span></p>
        <p>Depreciación diaria (COP/día): <span id="depreciationDisplay">{{ depreciation|currency }}</span></p>
    </div>

    <!-- Sección de Financiación -->
    <div class="my-4">
        <h2 class="h4 text-primary border-bottom pb-2 d-flex justify-content-between align-items-center">
            Financiación
            {% if asset_cost %}
                <a href="{% url 'con:financiacion-create' asset_cost.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus"></i>
                </a>
            {% endif %}
        </h2>
        {% if financiaciones %}
            <div class="mb-3">
                <p>
                    Total Intereses: {{ total_interest|currency }} 
                    ({{ total_interest_monthly|currency }} mensual)
                </p>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>Monto</th>
                                <th>Plazo (meses)</th>
                                <th>Fecha Desembolso</th>
                                <th>Fecha Vencimiento</th>
                                <th>Tasa de Interés</th>
                                <th>Número de Deuda</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fin in financiaciones %}
                                <tr>
                                    <td>{{ fin.monto|currency }}</td>
                                    <td>{{ fin.plazo }}</td>
                                    <td>{{ fin.fecha_desembolso|date:"d/m/Y" }}</td>
                                    <td>{{ fin.fecha_vencimiento|date:"d/m/Y" }}</td>
                                    <td>{{ fin.tasa_interes|mul:100|floatformat:2 }}%</td>
                                    <td>{{ fin.no_deuda }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <p class="small text-muted">No hay registros de financiación para este asset.</p>
        {% endif %}
    </div>

    <!-- Sección de Gastos -->
    <div class="my-4">
        <h2 class="h4 text-primary border-bottom pb-2 d-flex justify-content-between align-items-center">
            Gastos
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#gastosModal">
                <i class="bi bi-eye"></i>
            </button>
        </h2>
        <p>
            <strong>Contribución a los gastos:</strong> {{ asset_cost.cont_a_los_gastos|currency }}<br>
            <small class="text-muted">Factor de participación (FP): {{ asset_cost.fp|floatformat:4 }}</small>
        </p>
    </div>
</div>

<!-- Modal Bootstrap para actualizar el Costo Inicial -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="updateAssetCostForm" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">Actualizar Costo Inicial</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_initial_cost" class="form-label">Costo Inicial (COP):</label>
                        <input type="number" step="0.01" class="form-control" name="initial_cost" id="id_initial_cost" value="{{ asset_cost.initial_cost|default:'0.00' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Amplio para Mostrar Gastos Administrativos y Cargar Excel -->
<div class="modal fade" id="gastosModal" tabindex="-1" aria-labelledby="gastosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">  <!-- modal-lg para un modal amplio -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="gastosModalLabel">Registros de Gastos Administrativos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- Sección para subir archivo Excel -->
        <div class="mb-3">
          <label for="id_excel_file" class="form-label">Subir archivo Excel (.xlsx):</label>
          <input type="file" class="form-control" id="id_excel_file" name="excel_file" accept=".xlsx">
          <button id="uploadGastosBtn" class="btn btn-primary mt-2">Subir Archivo</button>
          <div id="uploadStatus" class="mt-2 text-info"></div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="table-primary">
              <tr>
                <th>Código</th>
                <th>Descripción</th>
                <th>Año</th>
                <th>Total</th>
                <th>Promedio Mes</th>
              </tr>
            </thead>
            <tbody>
              {% for gasto in gastos %}
              <tr>
                <td>{{ gasto.codigo }}</td>
                <td>{{ gasto.descripcion }}</td>
                <td>{{ gasto.anio }}</td>
                <td>{{ gasto.total|currency }}</td>
                <td>{{ gasto.promedio_mes|currency }}</td>
              </tr>
              {% endfor %}
              <tr class="fw-bold">
                <td colspan="3" class="text-end">Totales</td>
                <td>{{ total_gastos_sum|currency }}</td>
                <td>{{ total_promedio_sum|currency }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div> 

<script>
  // Actualización vía AJAX del Costo Inicial
  document.getElementById("updateAssetCostForm").addEventListener("submit", function(event) {
    event.preventDefault();
    const url = "{% url 'con:assetcost-update' asset_cost.pk %}";
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const initial_cost = document.getElementById("id_initial_cost").value;

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken
      },
      body: new URLSearchParams({
        "initial_cost": initial_cost
      })
    })
    .then(response => response.json())
    .then(data => {
      if(data.success) {
        const updateModal = bootstrap.Modal.getInstance(document.getElementById("updateModal"));
        updateModal.hide();
        window.location.reload();
      } else {
        alert("Error: " + JSON.stringify(data.errors));
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Error al actualizar.");
    });
  });

  // Envío del archivo Excel vía AJAX para cargar gastos administrativos
  document.getElementById("uploadGastosBtn").addEventListener("click", function(){
      const fileInput = document.getElementById("id_excel_file");
      const statusDiv = document.getElementById("uploadStatus");
      if(fileInput.files.length === 0) {
          alert("Por favor, seleccione un archivo.");
          return;
      }
      statusDiv.textContent = "Cargando archivo, por favor espere...";
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("excel_file", file);
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      fetch("{% url 'con:gastos-upload-ajax' %}", {
          method: "POST",
          headers: {
              "X-CSRFToken": csrftoken
          },
          body: formData
      })
      .then(response => response.json())
      .then(data => {
          if(data.success) {
              statusDiv.textContent = data.message;
              setTimeout(() => {
                  location.reload();
              }, 2000);
          } else {
              statusDiv.textContent = "Error: " + (data.error || JSON.stringify(data.errors));
          }
      })
      .catch(error => {
          console.error("Error:", error);
          statusDiv.textContent = "Error al subir el archivo.";
      });
  });
</script>
{% endblock %}
