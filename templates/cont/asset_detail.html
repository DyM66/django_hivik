{% extends "cont/finance_base.html" %}

{% load con_extras %}
{% block page_title %}
<a href="{% url 'cont:asset-list' %}"><i class="bi bi-arrow-bar-left"></i></a>
{{ asset_cost.asset.name }} - {{ asset_cost.codigo|default_if_none:"" }}
{% endblock %}
{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center">
        
        <h1 class="mb-0">
			
		</h1>
        <!-- Botón discreto con el ícono de lápiz -->
        <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#updateModal">
            <i class="bi bi-pencil" style="font-size: 1rem; color: #094067;"></i>
        </button>
    </div>

    <!-- Sección de Depreciación -->
    <div class="my-4">
        <h2 class="h4 text-primary border-bottom pb-2">Depreciación (10 años)</h2>
        <p>Total (Costo Inicial + Inversión): <span id="totalCostDisplay">{{ total_cost|currency }}</span></p>
        <p>Depreciación diaria (COP/día): <span id="depreciationDisplay">{{ depreciation|currency }}</span></p>
    </div>

    <!-- Sección de Financiación -->
    <div class="my-4">
        <h2 class="h4 text-primary border-bottom pb-2 d-flex justify-content-between align-items-center">
            Financiación
            {% if asset_cost %}
                <a href="{% url 'con:financiacion-create' asset_cost.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus"></i>
                </a>
            {% endif %}
        </h2>
        {% if financiaciones %}
            <div class="mb-3">
                <p>
                    Total Intereses: {{ total_interest|currency }} 
                    ({{ total_interest_monthly|currency }} mensual)
                </p>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>Monto</th>
                                <th>Plazo (meses)</th>
                                <th>Fecha Desembolso</th>
                                <th>Fecha Vencimiento</th>
                                <th>Tasa de Interés</th>
                                <th>Número de Deuda</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fin in financiaciones %}
                                <tr>
                                    <td>{{ fin.monto|currency }}</td>
                                    <td>{{ fin.plazo }}</td>
                                    <td>{{ fin.fecha_desembolso|date:"d/m/Y" }}</td>
                                    <td>{{ fin.fecha_vencimiento|date:"d/m/Y" }}</td>
                                    <td>{{ fin.tasa_interes|mul:100|floatformat:2 }}%</td>
                                    <td>{{ fin.no_deuda }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <p class="small text-muted">No hay registros de financiación.</p>
        {% endif %}
    </div>

    <!-- Sección de Gastos -->
    <div class="my-4">
        <h2 class="h4 text-primary border-bottom pb-2 d-flex justify-content-between align-items-center">
            Gastos
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#gastosModal">
                <i class="bi bi-eye"></i>
            </button>
        </h2>
        <p>
            <strong>Contribución a los gastos:</strong> {{ asset_cost.cont_a_los_gastos|currency }}<br>
            <small class="text-muted">Factor de participación (FP): {{ asset_cost.fp|floatformat:4 }}</small>
        </p>
		<p>
			<strong>Costos Directos:</strong> {{ asset_cost.total_costos_directos|currency }}
		</p>
    </div>
</div>

<!-- Modal Bootstrap para actualizar Costo Inicial y Código -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form action="{% url 'con:assetcost-update' asset_cost.pk %}" method="post">{% csrf_token %}
				<div class="modal-header">
					<h5 class="modal-title" id="updateModalLabel">Actualizar Información</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
				</div>
				<div class="modal-body">
					<!-- Campo Costo Inicial -->
					<div class="mb-3">
						<label for="id_initial_cost" class="form-label">Costo Inicial (COP):</label>
						<input type="number" class="form-control" id="id_initial_cost" name="initial_cost" value={{asset_cost.initial_cost|format_decimal_dot}}>
					</div>
					<!-- Campo Código -->
					<div class="mb-3">
						<label for="id_codigo" class="form-label">Código</label>
						<input type="text" class="form-control" id="id_codigo" name="codigo" value="{{ asset_cost.codigo }}">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-primary">Guardar Cambios</button>
				</div>
			</form>
		</div>
	</div>
</div>
  

<!-- Modal Amplio para Mostrar Gastos Administrativos y Cargar Excel -->
<div class="modal fade" id="gastosModal" tabindex="-1" aria-labelledby="gastosModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">  <!-- modal-xl para un modal mucho más amplio -->
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="gastosModalLabel">Registros de Gastos Administrativos</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<div class="modal-body">
			<!-- Sección para subir archivo Excel y seleccionar mes -->
				<div class="mb-3">
					<label for="id_excel_file" class="form-label">Subir archivo Excel (.xlsx):</label>
					<input type="file" class="form-control" id="id_excel_file" name="excel_file" accept=".xlsx">
					<label for="id_mes_upload" class="form-label mt-2">Mes (1-12):</label>
					<input type="number" min="1" max="12" class="form-control" id="id_mes_upload" name="mes" placeholder="Ingrese el mes">
					<button id="uploadGastosBtn" class="btn btn-primary mt-2">Subir Archivo</button>
					<div id="uploadStatus" class="mt-2 text-info"></div>
				</div>
				<!-- Tabla principal con los códigos contables agrupados -->
				<div class="table-responsive">
					<table class="table table-bordered table-striped">
						<thead class="table-primary">
							<tr>
								<th>Código</th>
								<th>Nombre</th>
								<th>Categoría</th>
								<th>Año</th>
								<th>Mes</th>
								<th>Total</th>
								<th>Promedio Mes</th>
							</tr>
						</thead>
					<tbody>
						{% for cc in codigos_contables_agrupados %}
						<tr data-bs-toggle="collapse" data-bs-target="#detail-{{ forloop.counter }}" class="clickable">
							<td>{{ cc.codigo }}</td>
							<td>{{ cc.nombre }}</td>
							<td>
								{% if cc.categoria == "ga" %}
									Gastos Administrativos
								{% elif cc.categoria == "cd" %}
									Costo Directo
								{% endif %}
							</td>
							<td>{{ cc.anio }}</td>
							<td>{{ cc.mes }}</td>
							<td>{{ cc.total|currency }}</td>
							<td>{{ cc.promedio|currency }}</td>
						</tr>
						<!-- Fila detalle colapsable -->
						<tr id="detail-{{ forloop.counter }}" class="collapse">
							<td colspan="7">
								<div class="table-responsive">
									<table class="table table-sm table-bordered">
										<thead class="table-secondary">
											<tr>
												<th>Cuenta</th>
												<th>Nombre Cuenta</th>
												<th>Total</th>
											</tr>
										</thead>
										<tbody>
											{% for detail in cc.detalles %}
												<tr>
													<td>{{ detail.codigo }}</td>
													<td>{{ detail.descripcion }}</td>
													<td>{{ detail.total|currency }}</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
				  			</td>
						</tr>
						{% endfor %}

						<!-- Fila final de totales -->
						<tr class="table-primary">
							<td colspan="5" style="text-align: right;"><strong>Total Gastos Administrativos:</strong></td>
							<td colspan="2">{{ total_gastos_sum|currency }}</td>
						</tr>
						<tr class="table-primary">
							<td colspan="5" style="text-align: right;"><strong>Total Costos Directos:</strong></td>
							<td colspan="2">{{ total_costos_directos|currency }}</td>
						</tr>

			  		</tbody>
				</table>
		  	</div>
		</div>
		<div class="modal-footer">
		   <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
		</div>
	</div>
</div>

<script>
	document.addEventListener("DOMContentLoaded", function() {
		
		// Función para enviar el archivo con opción de sobrescribir
		function sendUpload(overwriteFlag) {
			const fileInput = document.getElementById("id_excel_file");
			const mesInput = document.getElementById("id_mes_upload");
			const statusDiv = document.getElementById("uploadStatus");
			const formData = new FormData();
			formData.append("excel_file", fileInput.files[0]);
			formData.append("mes", mesInput.value);
			if(overwriteFlag) {
				formData.append("overwrite", "true");
			}
			const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
			fetch("{% url 'con:gastos-upload-ajax' %}", {
				method: "POST",
				headers: {
					"X-CSRFToken": csrftoken
				},
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				if(data.success) {
					statusDiv.textContent = data.message;
					setTimeout(() => {
						location.reload();
					}, 2000);
				} else {
					if(data.overwrite_required) {
						if(confirm("Ya existen registros para este mes. ¿Desea sobrescribir los datos?")) {
							// Reintentar con overwrite = true
							sendUpload(true);
						} else {
							statusDiv.textContent = "Operación cancelada por el usuario.";
						}
					} else {
						statusDiv.textContent = "Error: " + (data.error || JSON.stringify(data.errors));
					}
				}
			})
			.catch(error => {
				console.error("Error:", error);
				statusDiv.textContent = "Error al subir el archivo.";
			});
		}
		
		// Envío del archivo Excel vía AJAX para cargar gastos administrativos
		const uploadGastosBtn = document.getElementById("uploadGastosBtn");
		if (uploadGastosBtn) {
			uploadGastosBtn.addEventListener("click", function(){
				const fileInput = document.getElementById("id_excel_file");
				const mesInput = document.getElementById("id_mes_upload");
				const statusDiv = document.getElementById("uploadStatus");
				if(fileInput.files.length === 0) {
					alert("Por favor, seleccione un archivo.");
					return;
				}
				if(mesInput.value === "" || mesInput.value < 1 || mesInput.value > 12) {
					alert("Por favor, ingrese un mes válido (1-12).");
					return;
				}
				statusDiv.textContent = "Cargando archivo, por favor espere...";
				sendUpload(false);
			});
		}
	});
	</script>
	
{% endblock %}
