<!-- templates/outbound/place_form.html -->

{% extends "got/base/base_generic.html" %}

{% block content %}
<div class="container mt-4">
    <h2>{% if form.instance.pk %}Actualizar Lugar{% else %}Crear Nuevo Lugar{% endif %}</h2>
    <form method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">Nombre</label>
            {{ form.name }}
            {{ form.name.errors }}
        </div>
        <div class="mb-3">
            <label class="form-label">Seleccionar Ubicación en el Mapa</label>
            <div id="map" style="height: 400px;"></div>
            {{ form.latitude }}
            {{ form.longitude }}
            {{ form.latitude.errors }}
            {{ form.longitude.errors }}
        </div>
        <div class="mb-3">
            <label for="{{ form.contact_person.id_for_label }}" class="form-label">Persona de Contacto</label>
            {{ form.contact_person }}
            {{ form.contact_person.errors }}
        </div>
        <div class="mb-3">
            <label for="{{ form.contact_phone.id_for_label }}" class="form-label">Teléfono de Contacto</label>
            {{ form.contact_phone }}
            {{ form.contact_phone.errors }}
        </div>
        <button type="submit" class="btn btn-primary">{% if form.instance.pk %}Actualizar{% else %}Crear{% endif %}</button>
        <a href="{% url 'outbound:place-list' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- Incluir la API de Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDC4JuNX0U5YnJJCxBTCrnkl2ZupbOM4zA&libraries=places"></script>

<script>
    let map;
    let marker;
    let infowindow;

    function initMap() {
        // Coordenadas iniciales (puedes cambiarlas según tu preferencia)
        const initialLat = parseFloat(document.getElementById('id_latitude').value) || 4.7110;
        const initialLng = parseFloat(document.getElementById('id_longitude').value) || -74.0721;
        const initialPosition = { lat: initialLat, lng: initialLng };

        map = new google.maps.Map(document.getElementById("map"), {
            center: initialPosition,
            zoom: 12,
        });

        infowindow = new google.maps.InfoWindow();

        marker = new google.maps.Marker({
            position: initialPosition,
            map: map,
            draggable: true,
        });

        // Actualizar los campos de coordenadas al mover el marcador
        google.maps.event.addListener(marker, 'dragend', function(event) {
            document.getElementById('id_latitude').value = event.latLng.lat().toFixed(6);
            document.getElementById('id_longitude').value = event.latLng.lng().toFixed(6);
        });

        // Autocompletar de búsqueda
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Buscar ubicación';
        input.className = 'form-control mb-3';
        input.id = 'search-box';
        document.querySelector('form').insertBefore(input, document.getElementById('map'));

        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);

        autocomplete.setFields(['geometry']);

        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                alert("No se encontró la ubicación.");
                return;
            }

            // Si el lugar tiene una geometría, centra el mapa y mueve el marcador
            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            }

            marker.setPosition(place.geometry.location);
            document.getElementById('id_latitude').value = place.geometry.location.lat().toFixed(6);
            document.getElementById('id_longitude').value = place.geometry.location.lng().toFixed(6);
        });
    }

    // Inicializar el mapa al cargar la página
    window.onload = initMap;
</script>
{% endblock %}
