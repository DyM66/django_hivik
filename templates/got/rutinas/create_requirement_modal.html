<!-- templates/got/modals/create_requirement_modal.html -->
{% load my_tags %}
<!-- Modal Crear Requerimiento -->
<div class="modal fade" id="createRequirementModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="post" action="" id="createRequirementForm">{% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Crear Requerimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <!-- Botones para alternar entre Servicio y Artículo -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary me-2" id="articleBtn">Artículo</button>

                        <button type="button" class="btn btn-outline-primary" id="serviceBtn">Servicio</button>
                    </div>
  
                    <!-- Campos del formulario (ocultaremos/mostraremos con JS) -->
                    <div id="serviceFields" style="display:none;">
                        <div class="mb-3">
                            <label for="id_descripcion" class="form-label">Descripción del Servicio</label>
                            {{ requirement_form.descripcion }}
                        </div>
                        <input type="hidden" name="tipo" value="s" id="serviceTipo">
                        <div class="mb-3">
                            <label for="id_cantidad" class="form-label">Cantidad</label>
                            {{ requirement_form.cantidad }}
                        </div>
                    </div>
  
                    <div id="articleFields" style="display:none;">
                        <div class="mb-3">
                            <!-- Campo de búsqueda -->
                            <input type="text" class="form-control" id="itemSearch" placeholder="Buscar por nombre o referencia...">
                        </div>
  
                        <!-- Tabla de artículos -->
                        <div class="table-responsive" style="max-height:300px; overflow:auto;">
                            <table class="table table-striped" id="itemTable">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Articulo</th>
                                        <th>Presentación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for it in all_items %}
                                        <tr data-name="{{ it.name|lower }}" data-ref="{{ it.reference|lower }}">
                                            <td><input type="radio" name="item" value="{{ it.id }}" class="item-radio"></td>
                                            <td>{{ it }}</td>
                                            <td>{{ it.presentacion }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Tipo para artículo (solo 'herramienta/equipo' o 'material') -->
                        <div class="mb-3 mt-3">
                            <label for="articleTipo" class="form-label">Tipo</label>
                            <select name="tipo" class="form-control" id="articleTipo">
                                <option value="m">Material</option>
                                <option value="h">Herramienta/Equipo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="id_cantidad" class="form-label">Cantidad</label>
                            {{ requirement_form.cantidad }}
                        </div>
                    </div>
  
                </div>
                <div class="modal-footer">
                    <input type="hidden" name="action" value="create_requirement">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>
  
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const serviceBtn = document.getElementById('serviceBtn');
        const articleBtn = document.getElementById('articleBtn');
        const serviceFields = document.getElementById('serviceFields');
        const articleFields = document.getElementById('articleFields');
    
        const descripcionField = document.getElementById('id_descripcion');
        const tipoServiceHidden = document.getElementById('serviceTipo');
    
        const itemSearch = document.getElementById('itemSearch');
        const itemTable = document.getElementById('itemTable');
    
        // Por defecto, mostrar Artículo primero
        showArticleMode();
    
        serviceBtn.addEventListener('click', showServiceMode);
        articleBtn.addEventListener('click', showArticleMode);
    
        function showServiceMode() {
            serviceFields.style.display = 'block';
            articleFields.style.display = 'none';
            descripcionField.value = '';
            tipoServiceHidden.value = 's';
        }
    
        function showArticleMode() {
            serviceFields.style.display = 'none';
            articleFields.style.display = 'block';
            // Limpiar campos servicio
            descripcionField.value = '';
            tipoServiceHidden.value = ''; // no usar este en modo artículo
        }
    
        // Filtrado de la tabla de artículos
        itemSearch.addEventListener('input', function() {
            const filterValue = this.value.toLowerCase();
            const rows = itemTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                const ref = row.getAttribute('data-ref');
                if (name.includes(filterValue) || ref.includes(filterValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
</script>
    