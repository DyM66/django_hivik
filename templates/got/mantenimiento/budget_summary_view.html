{# got/templates/got/mantenimiento/budget_summary_view.html #}
{% extends "got/base/base_generic.html" %}
{% load my_tags %}

{% block content %}
<div class="container my-4">
    <h1>Resumen de Presupuesto por Barco</h1>
    <p style="font-size:0.9rem;">
        Período: {{ period_start|date:"d/m/Y" }} - {{ period_end|date:"d/m/Y" }}
    </p>

    {# Enlace (o botón) para ver la vista detallada: budget_view #}
    <p>
        Este reporte consolida el costo total estimado de los requerimientos para cada barco.
        <a class="btn btn-primary" href="{% url 'got:budget_view' %}">Ver detalle completo</a>
    </p>

    <!-- Tabla de Barcos (se muestra primero) -->
    <h2 style="font-size:1rem;" class="mt-4">Barcos</h2>
    <table class="table table-sm align-middle" style="font-size:0.9rem;">
        <thead>
            <tr>
                <th style="width:60%;">Barco</th>
                <th style="width:40%;">Presupuesto (COP)</th>
            </tr>
        </thead>
        <tbody>
        {% for asset in assets_data %}
            <tr class="asset-row" data-asset-id="{{ forloop.counter }}"> 
                <!-- Al hacer click se mostrará/ocultará la subfila -->
                <td>
                    <i class="bi bi-caret-right-fill me-1 toggle-icon"></i>
                    {{ asset.asset_name }}
                </td>
                <td>
                    {{ asset.asset_cost|currency }}
                </td>
            </tr>
            <!-- Sub-fila oculta con la tabla de equipos y las gráficas -->
            <tr class="equipos-row" id="equipos-row-{{ forloop.counter }}" style="display:none;">
                <td colspan="2">
                    <div class="row">
                        <!-- Primera columna: Tabla de Equipos -->
                        <div class="col-md-4">
                            <h5 style="font-size:0.95rem;">Desglose por Equipos</h5>
                            <table class="table table-sm align-middle table-bordered" style="font-size:0.85rem;">
                                <thead>
                                    <tr>
                                        <th>Equipo</th>
                                        <th>Presupuesto (COP)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for eq in asset.equipos %}
                                    <tr>
                                        <td>{{ eq.equipo_name }}</td>
                                        <td>{{ eq.cost|currency }}</td>
                                    </tr>
                                    {% endfor %}
                                    <!-- Fila Micelanios por Equipos -->
                                    <tr>
                                        <td><strong>Micelanios (10%)</strong></td>
                                        <td><strong>{{ asset.micelanios|currency }}</strong></td>
                                    </tr>
                                    <!-- Fila Total con Micelanios -->
                                    <tr>
                                        <td><strong>Total</strong></td>
                                        <td><strong>{{ asset.asset_cost|currency }}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Segunda columna: Gráfica 1 - Distribución por Equipos -->
                        <div class="col-md-4">
                            <h5 style="font-size:0.95rem;">Distribución por Equipos</h5>
                            <div style="max-width:500px; margin-bottom:2rem;">
                                <canvas id="equiposPieChart{{ forloop.counter }}"></canvas>
                            </div>
                        </div>
                        <!-- Tercera columna: Gráfica 2 - Distribución por Tipo -->
                        <div class="col-md-4">
                            <h5 style="font-size:0.95rem;">Distribución por Tipo</h5>
                            <div style="max-width:500px;">
                                <canvas id="categoriesPieChart{{ forloop.counter }}"></canvas>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="2">No hay barcos disponibles.</td>
            </tr>
        {% endfor %}
        <!-- Fila Total Global con Micelanios -->
        <tr>
            <td class="text-end"><strong>Total Global (Incluye 10% Micelanios)</strong></td>
            <td><strong>{{ total_global|currency }}</strong></td>
        </tr>
        </tbody>
    </table>

    <!-- Gráfico circular principal con % por barco + Micelanios, se muestra después de la tabla -->
    <h3 style="font-size:1rem;">Distribución Total</h3>
    <div style="max-width:600px;">
        <canvas id="mainPieChart"></canvas>
    </div>

</div>

<!-- Librería Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

<script>
    // Depuración: Verificar el contenido de assets_data_json
    console.log("assets_data_json:", '{{ assets_data_json|escapejs }}');

    // 1) Datos para el gráfico principal (todos los barcos + Micelanios)
    var mainLabels = JSON.parse('{{ pie_labels|escapejs }}');
    var mainData   = JSON.parse('{{ pie_data|escapejs }}');

    // 2) Configuración para tooltips en % (Chart.js 2.x)
    function tooltipPercentage(tooltipItem, data) {
      var dataset = data.datasets[tooltipItem.datasetIndex];
      var currentValue = dataset.data[tooltipItem.index];
      var total = dataset.data.reduce((a, b) => a + b, 0);
      var percentage = ((currentValue / total) * 100).toFixed(1) + '%';
      return data.labels[tooltipItem.index] + ': ' + percentage;
    }

    // 3) Crear el gráfico principal DESPUÉS de la tabla
    var ctxMain = document.getElementById('mainPieChart').getContext('2d');
    var mainPieChart = new Chart(ctxMain, {
        type: 'pie',
        data: {
            labels: mainLabels,
            datasets: [{
                data: mainData,
                backgroundColor: [
                  'rgba(54, 162, 235, 0.7)',
                  'rgba(255, 99, 132, 0.7)',
                  'rgba(255, 159, 64, 0.7)',
                  'rgba(75, 192, 192, 0.7)',
                  'rgba(153, 102, 255, 0.7)',
                  'rgba(201, 203, 207, 0.7)'  // Micelanios
                ],
            }]
        },
        options: {
            responsive: true,
            legend: { position: 'bottom' },
            tooltips: {
                callbacks: { label: tooltipPercentage }
            }
        }
    });

    // 4) Datos para gráficos de equipos y categorías (cada barco):
    var assetsData = JSON.parse('{{ assets_data_json|escapejs }}');
    /* 
       assetsData es una lista de dict, cada dict:
       {
         "asset_id": ...,
         "asset_name": ...,
         "asset_cost": float,
         "micelanios": float,  # Nuevo
         "equipos": [...],
         "labels_equipos": [...],
         "data_equipos": [...],
         "labels_categories": [...],
         "data_categories": [...],
       }
    */

    console.log("assetsData:", assetsData); // Depuración: Verificar la estructura de assetsData
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let rows = document.querySelectorAll('.asset-row');
        rows.forEach((row) => {
            row.addEventListener('click', function() {
                let assetId = row.getAttribute('data-asset-id');
                let subRow  = document.getElementById('equipos-row-' + assetId);

                // Toggle sub-fila
                if (subRow.style.display === 'none') {
                    subRow.style.display = '';
                    let icon = row.querySelector('.toggle-icon');
                    if (icon) {
                        icon.classList.remove('bi-caret-right-fill');
                        icon.classList.add('bi-caret-down-fill');
                    }
                    // Crear los charts si no existen
                    createEquiposChart(assetId);
                    createCategoriesChart(assetId);
                } else {
                    subRow.style.display = 'none';
                    let icon = row.querySelector('.toggle-icon');
                    if (icon) {
                        icon.classList.remove('bi-caret-down-fill');
                        icon.classList.add('bi-caret-right-fill');
                    }
                }
            });
        });
    });

    function createEquiposChart(assetId) {
        let canvasId = "equiposPieChart" + assetId;
        let ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.error("Canvas not found for equiposPieChart:", canvasId);
            return;
        }

        let i = parseInt(assetId) - 1;
        let thisAsset = assetsData[i];

        if (!thisAsset) {
            console.error("No data found for assetId:", assetId, "Index:", i);
            return;
        }

        console.log("Creating Equipos Chart for assetId:", assetId, "Index:", i, "Data:", thisAsset);

        let config = {
          type: 'pie',
          data: {
            labels: thisAsset.labels_equipos,
            datasets: [{
              data: thisAsset.data_equipos,
              backgroundColor: [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(201, 203, 207, 0.7)'
              ]
            }]
          },
          options: {
            responsive: true,
            legend: { position: 'bottom' },
            tooltips: {
              callbacks: { label: tooltipPercentage }
            }
          }
        };
        new Chart(ctx, config);
    }

    function createCategoriesChart(assetId) {
        let canvasId = "categoriesPieChart" + assetId;
        let ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.error("Canvas not found for categoriesPieChart:", canvasId);
            return;
        }

        let i = parseInt(assetId) - 1;
        let thisAsset = assetsData[i];

        if (!thisAsset) {
            console.error("No data found for assetId:", assetId, "Index:", i);
            return;
        }

        console.log("Creating Categories Chart for assetId:", assetId, "Index:", i, "Data:", thisAsset);

        let config = {
          type: 'pie',
          data: {
            labels: thisAsset.labels_categories,
            datasets: [{
              data: thisAsset.data_categories,
              backgroundColor: [
                'rgba(255, 206, 86, 0.7)',    // Aceite y Filtros
                'rgba(75, 192, 192, 0.7)',    // Servicios
                'rgba(201, 203, 207, 0.7)'     // Repuestos
              ]
            }]
          },
          options: {
            responsive: true,
            legend: { position: 'bottom' },
            tooltips: {
              callbacks: { label: tooltipPercentage }
            }
          }
        };
        new Chart(ctx, config);
    }
</script>

{% endblock %}
