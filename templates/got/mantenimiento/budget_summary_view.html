{% extends "got/base/base_generic.html" %}
{% load my_tags %}

{% block content %}
<div class="container my-4">
    <!-- CUADRO: Encabezado y texto explicativo -->
    <div class="shadow p-4 mb-4" style="background-color: #f0f4ff; border-radius: 12px;">
        <h1 style="margin-bottom: 0.5rem; color: #191645;">Resumen de Presupuesto por Barco</h1>
        <p style="font-size:0.9rem; color: #333;">
            Período: {{ period_start|date:"d/m/Y" }} - {{ period_end|date:"d/m/Y" }}
        </p>
        <p style="font-size: 0.9rem; color: #333;">
            Este reporte consolida el costo total estimado de los requerimientos para cada barco.
            <a class="btn btn-primary" href="{% url 'got:budget_view' %}">Ver detalle completo</a>
        </p>
    </div>

    <!-- CONTENEDOR FLEX: Tabla Izquierda, Detalle Derecha -->
    <div style="display: flex; gap: 1rem; align-items: flex-start;">
        
        <!-- Sección Izquierda: Tabla de Barcos -->
        <div style="flex: 0 0 40%;">
            <table class="table-list table-sm align-middle" 
                   style="font-size: 0.9rem; border-collapse: collapse; width: 100%;">
                <thead>
                    <tr>
                        <th style="width: 60%; font-weight: normal;">Barco</th>
                        <th style="width: 40%; font-weight: normal;">Presupuesto (COP)</th>
                    </tr>
                </thead>
                <tbody>
                {% for asset in assets_data %}
                    <!-- Cada fila, en el onclick, llamamos a showAssetDetails con el índice -->
                    <tr onclick="showAssetDetails({{ forloop.counter0 }})" style="cursor: pointer;">
                        <td>{{ asset.asset_name }}</td>
                        <td>{{ asset.asset_cost|currency }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="2">No hay barcos disponibles.</td>
                    </tr>
                {% endfor %}
                <tr>
                    <td class="text-end"><strong>Total Global (Incluye 10% Micelanios)</strong></td>
                    <td><strong>{{ total_global|currency }}</strong></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Sección Derecha: Detalle dinámico -->
        <div class="shadow p-3" style="background-color: #f0f4ff; border-radius: 12px; color: #191645; flex: 1;">
            <!-- Título del barco clicado -->
            <h1 id="detailAssetTitle" style="font-size:2rem; margin-bottom: 1rem; color: #191645;">
                <!-- Se actualizará vía JS -->
                Selecciona un barco...
            </h1>
            
            <!-- Gráfico de Barras para Equipos -->
            <div style="width: 100%; height: 400px; margin-bottom: 2rem;">
                <canvas id="equiposBarChart"></canvas>
            </div>

            <!-- Gráfico Circular (Pie/Donut) para Tipos -->
            <div style="width: 100%; max-width: 500px; margin: 0 auto;">
                <canvas id="typesPieChart"></canvas>
            </div>
        </div>
    </div> <!-- Fin contenedor flex -->
</div>  <!-- fin container -->

<!-- Chart.js 2.9 + plugin datalabels (opcional si deseas porcentajes) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>

<script>
    // assetsData vendrá del servidor.
    // Ejemplo de la estructura: 
    // [
    //   {
    //     "asset_name": "Barco1",
    //     "asset_cost": 123456,
    //     "equipos_labels": ["Motor1", "Motor2", "Bomba X"],
    //     "equipos_data": [50000, 40000, 33456],
    //     "types_labels": ["Aceite y Filtros", "Servicios", "Repuestos"],
    //     "types_data": [25000, 35000, 63456]
    //   },
    //   { ... },
    //   ...
    // ]
    //
    // Asumimos que en Django lo pasamos como JSON (assetsDataJson).
    // O si prefieres, ya lo inyectas con "assets_data" y conviertes a JSON.
</script>

<script>
    // 1) Tomamos la variable que Django nos pasa
    var assetsData = JSON.parse('{{ assetsDataJson|escapejs }}'); 
    // O si lo pasas como "assets_data", conviértelo a JSON en la vista y pégalo aquí

    // 2) Instancias Chart
    var equiposBarChart; 
    var typesPieChart;

    // 3) Al cargar la página, configuramos los 2 canvas
    document.addEventListener('DOMContentLoaded', function() {
        let ctxEquipos = document.getElementById('equiposBarChart').getContext('2d');
        let ctxTypes = document.getElementById('typesPieChart').getContext('2d');

        // Inicializamos con gráficos vacíos
        equiposBarChart = new Chart(ctxEquipos, {
            type: 'horizontalBar',
            data: {
                labels: [],
                datasets: [{
                    label: "Presupuesto Equipos",
                    data: [],
                    backgroundColor: "rgba(173, 216, 230, 0.6)",
                    borderColor: "transparent"
                }]
            },
            options: {
                responsive: true,
                scales: {
                    yAxes: [{
                        barPercentage: 0.8,
                        categoryPercentage: 0.8,
                        ticks: {},
                        gridLines: { display: false }
                    }],
                    xAxes: [{
                        ticks: {
                            beginAtZero: true,
                            // Podrías usar la abreviación
                        }
                    }]
                },
                legend: { display: false }
            }
        });

        typesPieChart = new Chart(ctxTypes, {
            type: 'pie', 
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        "rgba(255, 160, 122, 0.6)",
                        "rgba(152, 251, 152, 0.6)",
                        "rgba(255, 99, 71, 0.6)"
                    ],
                    borderColor: "transparent"
                }]
            },
            options: {
                responsive: true,
                legend: { position: 'bottom' }
            }
        });
    });

    // 4) Función que se llama al hacer clic en la tabla (fila)
    function showAssetDetails(index) {
        let asset = assetsData[index];
        if(!asset) return;

        // Actualiza el título
        let titleEl = document.getElementById("detailAssetTitle");
        titleEl.textContent = asset.asset_name; // Nombre del barco en grande

        // Actualiza el bar chart de equipos
        //  - cambiamos las labels y data
        equiposBarChart.data.labels = asset.equipos_labels;
        equiposBarChart.data.datasets[0].data = asset.equipos_data;
        
        // Podrías poner color distinto por cada equipo si gustas
        //   p.ej. generar un array de colores brandColors, mapear por idx...
        //   Por simplicidad, dejamos un solo color translúcido.

        equiposBarChart.update();

        // Actualiza el pie chart de tipos
        typesPieChart.data.labels = asset.types_labels;
        typesPieChart.data.datasets[0].data = asset.types_data;
        typesPieChart.update();
    }
</script>
{% endblock %}
