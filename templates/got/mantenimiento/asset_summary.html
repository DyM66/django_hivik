{% load my_tags %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Resumen</title>

</head>
<body>
    <!-- Página 1: Resumen de Activos -->
    <div class="summary-container">
        <h1 style="width:100%; text-align:center; margin-bottom:1rem;">Resumen de Activos</h1>
        {% for asset_detail in selected_assets %}
            <div class="asset-card">
                <h3>{{ asset_detail.asset.name }}</h3>
                <p><strong>Código:</strong> {{ asset_detail.asset.abbreviation }}</p>
                <p><strong>Supervisor:</strong> {{ asset_detail.supervisor_name }}</p>
                <p><strong>Capitán:</strong> {{ asset_detail.captain_name }}</p>
                <p><strong>Ubicación:</strong> {{ asset_detail.location }}</p>
                <p><strong>Compliance:</strong> {{ asset_detail.compliance }}%</p>
                <p><strong>Fallas abiertas:</strong> {{ asset_detail.failures_count }}</p>
            </div>
        {% endfor %}
    </div>

    <!-- Páginas de Detalle para cada Activo -->
    {% for asset_detail in selected_assets %}
        <div class="detail-section">
            <h2>Detalle: {{ asset_detail.asset.name }} ({{ asset_detail.asset.abbreviation }})</h2>
      
      <!-- Órdenes de Trabajo en Ejecución -->
      <h3>Órdenes de Trabajo en Ejecución</h3>
      {% if asset_detail.ots %}
        {% for ot_detail in asset_detail.ots %}
            <div class="ot-card">
                <h3>OT-{{ ot_detail.ot.num_ot }}: {{ ot_detail.ot.description }}</h3>
                <p><strong>Creado:</strong> {{ ot_detail.ot.creation_date|date:"d/m/Y" }}</p>
                <p><strong>Supervisor:</strong> {{ ot_detail.ot.supervisor }}</p>
                <table>
                    <thead>
                        <tr>
                        <th>Actividad</th>
                        <th>Responsable</th>
                        <th>Inicio</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if ot_detail.tasks_open %}
                            {% for task in ot_detail.tasks_open %}
                                <tr>
                                    <td>{{ task.description }}</td>
                                    <td>{% if task.responsible %}{{ task.responsible.get_full_name }}{% else %}---{% endif %}</td>
                                    <td>{% if task.start_date %}{{ task.start_date|date:"d/m/Y" }}{% else %}---{% endif %}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="3">No hay actividades abiertas.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                {% if ot_detail.tasks_closed %}
                    <p><strong>Actividades Finalizadas:</strong></p>
                    <table>
                        <thead>
                            <tr>
                                <th>Actividad</th>
                                <th>Responsable</th>
                                <th>Inicio</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in ot_detail.tasks_closed %}
                                <tr>
                                    <td>{{ task.description }}</td>
                                    <td>{% if task.responsible %}{{ task.responsible.get_full_name }}{% else %}---{% endif %}</td>
                                    <td>{% if task.start_date %}{{ task.start_date|date:"d/m/Y" }}{% else %}---{% endif %}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
                {% if ot_detail.failure %}
                    <p><strong>Reporte de Falla Asociado:</strong> Reporte ID {{ ot_detail.failure.id }}</p>
                {% endif %}
                {% if ot_detail.rutina %}
                    <p><strong>Rutina de Mantenimiento Asociada:</strong> {{ ot_detail.rutina.name }}</p>
                {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>No hay órdenes de trabajo en ejecución para este activo.</p>
        {% endif %}

        <!-- Reportes de Falla Abiertos -->
        <h3>Reportes de Falla Abiertos</h3>
        {% if asset_detail.failures_data %}
            <table class="failures-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Crítico</th>
                        <th>Generado por</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for failure in asset_detail.failures_data %}
                        <tr>
                            <td>{{ failure.id }}</td>
                            <td>{% if failure.critico %}Sí{% else %}No{% endif %}</td>
                            <td>{{ failure.reporter__username }}</td>
                            <td>{{ failure.description }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No hay reportes de falla abiertos para este activo.</p>
        {% endif %}
        </div>
  {% endfor %}
</body>
</html>
