<!DOCTYPE html>
<html lang="es">
<head>
	{% include 'got/base/links.html' %}
	{% block headtag %}{% endblock %}
</head>
<body>
	{% include 'got/base/navegacion.html' %}

    {% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="toast-header" style="background-color: #ffc107; color: #000;">
                <strong class="me-auto">Mensaje</strong>
                <small>{{ message.tags }}</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                {{ message }}
            </div>	
        </div>
        {% endfor %}
    </div>
    {% endif %}

	<!-- Contenido -->
	{% block content %}{% endblock %}

	{% if is_paginated %}
		<div class="px-3 mt-2" style="overflow-x: auto;">
			<nav aria-label="Page navigation">
				<ul class="pagination">
					{% if page_obj.has_previous %}
						<li class="page-item">
							<a class="page-link" href="{{ request.path }}?{{ request.GET.urlencode }}&page=1" tabindex="-1" aria-disabled="true">Primera</a>
						</li>
						<li class="page-item">
							<a class="page-link" href="{{ request.path }}?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}"><i class="bi bi-caret-left-fill"></i></a>
						</li>
					{% endif %}
	
					{% for num in page_obj.paginator.page_range %}
						{% if page_obj.number == num %}
							<li class="page-item active" aria-current="page"><a class="page-link" href="#">{{ num }}</a></li>
						{% elif num > page_obj.number|add:'-20' and num < page_obj.number|add:'20' %}
							<li class="page-item"><a class="page-link" href="{{ request.path }}?{{ request.GET.urlencode }}&page={{ num }}">{{ num }}</a></li>
						{% endif %}
					{% endfor %}
	
					{% if page_obj.has_next %}
						<li class="page-item">
							<a class="page-link" href="{{ request.path }}?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}"><i class="bi bi-caret-right-fill"></i></a>
						</li>
						<li class="page-item">
							<a class="page-link" href="{{ request.path }}?{{ request.GET.urlencode }}&page={{ page_obj.paginator.num_pages }}">Última</a>
						</li>
					{% endif %}
				</ul>
			</nav>
		</div>
	{% endif %}

	<hr class="bottom-line">
	<footer class="container">
		<p>
			Departamento de mantenimiento - Servicios portuarios SERPORT SAS
	  	</p>
	  	<p>Version v3.0.0 </p>
	</footer>
<!-- Contenedor de notificaciones -->
<div id="notification-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1050;"></div>

<!-- Botón flotante de Soporte Técnico -->
<div id="floatingSupport" class="floating-support">
    <i class="bi bi-headset icon"></i>
    <span class="text">Soporte Técnico</span>
</div>


<!-- Menú de Soporte Técnico (inicialmente oculto) -->
<div id="supportMenu" class="support-menu">
    <ul>
       <li>
         <a href="#" data-bs-toggle="modal" data-bs-target="#ticketModal">Reportar falla / Solicitar apoyo</a>
       </li>
       <li>
         <a href="#" data-bs-toggle="modal" data-bs-target="#faqModal">Dudas sobre el proceso</a>
       </li>
    </ul>
</div>


    <!-- Modal Ticket Creation -->
    <div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{% url 'tic:ticket-create' %}" method="post" id="ticketForm">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="ticketModalLabel">Reportar falla / Solicitar apoyo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        {{ ticket_form.as_p }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Enviar Ticket</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal FAQ -->
    <div class="modal fade" id="faqModal" tabindex="-1" aria-labelledby="faqModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="faqModalLabel">Dudas sobre el proceso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
					<p>
						Aquí puedes encontrar respuestas a las dudas más frecuentes sobre el proceso. 
						Si requieres asistencia adicional, por favor comunícate con el 
						<a href="#" data-bs-toggle="modal" data-bs-target="#ticketModal" style="text-decoration: underline">departamento de Tecnologías</a>.
					</p>
					<!-- Bloque para que cada vista inyecte su lista de procesos -->
					<div class="list-group">
						{% block faq_processes %}
						<a href="#" class="list-group-item list-group-item-action disabled" aria-disabled="true">
						  	No se han configurado procesos.
						</a>
						{% endblock %}
					</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/5.1.0/intro.min.js"></script>

<style>
:root {
    --color-primary: #191645;
}

/* Botón flotante, inicialmente circular y de 50x50 */
.floating-support {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1050;
    width: 50px;
    height: 50px;
    border: 2px solid var(--color-primary);
    border-radius: 50%;
    background-color: #fff;
    overflow: hidden; /* Oculta el texto cuando está retraído */
    transition: width 0.3s ease, border-radius 0.3s ease;
}

/* Estado expandido: se activa por hover o con la clase "open" */
.floating-support.open,
.floating-support:hover {
    width: 200px;
    border-radius: 25px;
}

/* Icono: posicionado absolutamente a la derecha y centrado verticalmente */
.floating-support .icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 24px;
    color: var(--color-primary);
}

/* Texto: posicionado absolutamente a la izquierda, inicialmente oculto */
.floating-support .text {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    color: var(--color-primary);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* Cuando se expande (hover o "open") se muestra el texto */
.floating-support.open .text,
.floating-support:hover .text {
    opacity: 1;
}

/* Menú de soporte: se levanta un poco más para no quedar pegado */
.support-menu {
    position: fixed;
    bottom: 90px; /* Más arriba que el botón */
    right: 20px;
    background-color: #fff;
    border: 2px solid var(--color-primary);
    border-radius: 8px;
    box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
    padding: 10px;
    display: none;
    z-index: 1050;
}

.support-menu ul {
    list-style: none;
    margin: 0;
    padding: 0;
}

.support-menu ul li {
    margin: 5px 0;
}

.support-menu ul li a {
    display: block;
    padding: 5px 10px;
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    transition: background-color 0.2s ease, color 0.2s ease;
}

.support-menu ul li a:hover {
    background-color: var(--color-primary);
    color: #fff;
    border-radius: 4px;
}

</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const floatingSupport = document.getElementById('floatingSupport');
        const supportMenu = document.getElementById('supportMenu');

        // Función para mostrar/ocultar el menú y añadir/quitar la clase "open"
        function toggleSupportMenu(e) {
            e.stopPropagation();
            if (supportMenu.style.display === "none" || supportMenu.style.display === "") {
                supportMenu.style.display = "block";
                floatingSupport.classList.add("open");
            } else {
                supportMenu.style.display = "none";
                floatingSupport.classList.remove("open");
            }
        }

        floatingSupport.addEventListener('click', toggleSupportMenu);

        // Cerrar el menú al hacer click fuera
        document.addEventListener('click', function() {
            if (supportMenu.style.display === "block") {
                supportMenu.style.display = "none";
                floatingSupport.classList.remove("open");
            }
        });

        // Prevenir cierre del menú al hacer click dentro de él
        supportMenu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    </script>
	

<style>
	/* Estilo para los toasts */
	.toast {
		width: 400px;
		margin-bottom: 10px;
		padding: 5px;
	}
</style>

<script>
    // Función para obtener notificaciones del servidor (por ejemplo, vía fetch)
    function fetchNotifications() {
        fetch("{% url 'got:get_notifications' %}").then(response => response.json()).then(data => {
            const container = document.getElementById("notification-container");
            container.innerHTML = "";
            data.notifications.forEach(notification => {
                // Crear la caja de notificación y asignar el ID de la notificación al dataset
                const div = document.createElement("div");
				div.className = "toast";
				div.setAttribute("role", "alert");
                div.setAttribute("aria-live", "assertive");
                div.setAttribute("aria-atomic", "true");
                div.setAttribute("data-bs-autohide", "false");
                // div.className = "notification-box";
                div.dataset.notificationId = notification.id;
				div.innerHTML = `
                            <div class="toast-header">
                                <strong class="me-auto">${notification.title}</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close" onclick="markAsSeen('${notification.id}');"></button>
                            </div>
                            <div class="toast-body">
                                <p>${notification.message}</p>
								<a href="#" onclick="handleNotificationClick('${notification.id}', '${notification.redirect_url}'); return false;">Ver detalle</a>	
								
                                <small>${notification.created_at}</small>
                            </div>
                        `;

                container.appendChild(div);
				var toast = new bootstrap.Toast(div);
				toast.show();
            });
        });
    }

	function handleNotificationClick(notificationId, redirectUrl) {
		markAsSeen(notificationId);
		window.location.href = redirectUrl;
	}

    // Función para marcar la notificación como vista (ejemplo con fetch)
    function markAsSeen(notificationId) {
        fetch("{% url 'got:mark_notification_seen' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: "notification_id=" + notificationId
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error("Error al marcar notificación como vista:", data.error);
            }
        });
    }

    // Polling: llamar a fetchNotifications cada 30 segundos
    document.addEventListener("DOMContentLoaded", function() {
        fetchNotifications();
        setInterval(fetchNotifications, 30000);
    });

    // Llamar a fetchNotifications al cargar la página
    // document.addEventListener("DOMContentLoaded", fetchNotifications);
</script>



	<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

	<script>
		// Verificar si la Badging API es soportada
		function isBadgingSupported() {
			return ('setAppBadge' in navigator || 'setClientBadge' in navigator);
		}

		// Función para actualizar el badge
		async function updateBadge(count) {
			if (isBadgingSupported()) {
				try {
					if ('setAppBadge' in navigator) {
						await navigator.setAppBadge(count);
					} else if ('setClientBadge' in navigator) {
						await navigator.setClientBadge(count);
					}
				} catch (error) {
					console.error('Error al establecer el badge:', error);
				}
			}
		}

		// Función para borrar el badge
		async function clearBadge() {
			if (isBadgingSupported()) {
				try {
					if ('clearAppBadge' in navigator) {
						await navigator.clearAppBadge();
					} else if ('clearClientBadge' in navigator) {
						await navigator.clearClientBadge();
					}
				} catch (error) {
					console.error('Error al borrar el badge:', error);
				}
			}
		}

		// Función para actualizar el título de la página
		function updatePageTitle(count) {
			if (count > 0) {
				document.title = `(${count}) GOT - Serport`;
			} else {
				document.title = `GOT - Serport`;
			}
		}

		// Función para obtener el conteo y actualizar el badge y el título
		function fetchUnapprovedRequestsCount() {
			fetch('{% url "got:unapproved_requests_count_api" %}')
				.then(response => response.json())
				.then(data => {
					const count = data.count;

					// Actualizar el badge
					updateBadge(count);

					// Actualizar el título de la página
					updatePageTitle(count);
				})
				.catch(error => console.error('Error al obtener el conteo:', error));
		}

		// Actualizar al cargar la página
		document.addEventListener('DOMContentLoaded', fetchUnapprovedRequestsCount);

		// Actualizar cada 60 segundos
		setInterval(fetchUnapprovedRequestsCount, 60000);

		document.addEventListener('DOMContentLoaded', function() {
			const forms = document.querySelectorAll('form');
	
			forms.forEach(form => {
				let isSubmitting = false;
				const submitButtons = form.querySelectorAll('.submit-button');
	
				submitButtons.forEach(button => {
					button.disabled = false;
					// Opcional: Restablecer el texto del botón si es necesario
					// button.innerHTML = 'Enviar'; // Ajusta el texto según corresponda
				});
	
				form.addEventListener('input', function() {
					if (isSubmitting) {
						submitButtons.forEach(button => {
							button.disabled = false;
							// Opcional: Restablecer el texto del botón
							// button.innerHTML = 'Enviar'; // Ajusta el texto según corresponda
						});
						isSubmitting = false;
					}
				});
	
				form.addEventListener('submit', function(event) {
					if (isSubmitting) {
						event.preventDefault();
						return;
					}
					isSubmitting = true;
	
					submitButtons.forEach(button => {
						button.disabled = true;
						button.innerHTML = 'Enviando...'; // Ajusta el texto según corresponda
						// Opcional: Añadir una clase para estilos adicionales
						button.classList.add('loading');
					});
				});
			});
		});
	</script>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const ticketForm = document.getElementById('ticketForm');
		if(ticketForm) {
			ticketForm.addEventListener('submit', function(e) {
				e.preventDefault();
				const submitButton = ticketForm.querySelector('button[type="submit"]');
				submitButton.disabled = true;
				submitButton.innerHTML = 'Enviando...';
				const formData = new FormData(ticketForm);
				fetch(ticketForm.action, {
					method: 'POST',
					headers: {
						'X-Requested-With': 'XMLHttpRequest'
					},
					body: formData
				})
				.then(response => response.json())
				.then(data => {
					if(data.success) {
						// Reiniciar el formulario
						ticketForm.reset();
						// Ocultar el modal (utilizando la API de Bootstrap)
						const ticketModalEl = document.getElementById('ticketModal');
						const ticketModal = bootstrap.Modal.getInstance(ticketModalEl);
						ticketModal.hide();
						// Mostrar mensaje de éxito
						showToast(data.message);
					} else {
						// Mostrar errores (por ejemplo, concatenando los mensajes de error)
						let errorText = "";
						for (const [field, errors] of Object.entries(data.errors)) {
							errorText += field + ": " + errors.join(', ') + "\n";
						}
						showToast("Error: " + errorText);
					}
					submitButton.disabled = false;
					submitButton.innerHTML = 'Enviar Ticket';
				})
				.catch(error => {
					console.error('Error:', error);
					showToast('Ocurrió un error, por favor intente nuevamente.');
					submitButton.disabled = false;
					submitButton.innerHTML = 'Enviar Ticket';
				});
			});
		}
	});
	
	// Función para mostrar un toast de confirmación
	function showToast(message) {
		const container = document.getElementById('notification-container');
		// Crear el elemento del toast
		const toastEl = document.createElement('div');
		toastEl.className = 'toast';
		toastEl.setAttribute('role', 'alert');
		toastEl.setAttribute('aria-live', 'assertive');
		toastEl.setAttribute('aria-atomic', 'true');
		toastEl.innerHTML = `
			<div class="toast-header">
				<strong class="me-auto">Soporte Técnico</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body">
				${message}
			</div>
		`;
		container.appendChild(toastEl);
		const toast = new bootstrap.Toast(toastEl, { delay: 10000 });
		toast.show();
		// Remover el toast del DOM cuando se oculte
		toastEl.addEventListener('hidden.bs.toast', function() {
			toastEl.remove();
		});
	}
	</script>
	

	{% block faq_extra_js %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/5.1.0/intro.min.js"></script>
	<script>
	document.addEventListener("DOMContentLoaded", function(){
	  // Selecciona todos los elementos que tienen el atributo data-tutorial
	  const processItems = document.querySelectorAll("[data-tutorial]");
	  processItems.forEach(function(item) {
		item.addEventListener("click", function(e) {
		  e.preventDefault();
		  // Cierra el modal FAQ (opcional)
		  const faqModalEl = document.getElementById("faqModal");
		  const faqModal = bootstrap.Modal.getInstance(faqModalEl);
		  if (faqModal) {
			faqModal.hide();
		  }
		  // Obtén el nombre del tutorial desde el atributo
		  const tutorialName = this.getAttribute("data-tutorial");
		  // Inicia el tour para ese proceso
		  startTutorial(tutorialName);
		});
	  });
	});
	
	function startTutorial(tutorialName) {
	  let steps = [];
	  // Define los pasos para cada proceso según el valor de tutorialName
	  switch(tutorialName) {
		case "horas-report":
		  steps = [
			{
			  element: document.querySelector("table#tableHours thead"),
			  intro: "Estas son las fechas de reporte; cada columna representa un día en el que se debe registrar las horas.",
			  position: "bottom"
			},
			{
			  element: document.querySelector("table#tableHours tbody tr td:first-child"),
			  intro: "Cada fila corresponde a un equipo. Aquí se muestra el nombre del equipo y su horómetro actual.",
			  position: "right"
			},
			{
			  element: document.querySelector("i.edit-hour"),
			  intro: "Haz clic en este icono de lápiz para reportar las horas trabajadas para esa fecha.",
			  position: "top"
			},
			{
			  element: document.getElementById("editHourModal"),
			  intro: "En este modal podrás ingresar las horas trabajadas (entre 0 y 24) y guardar el reporte.",
			  position: "left"
			}
		  ];
		  break;
		// Agrega otros casos según sea necesario
		default:
		  steps = [];
	  }
	  if (steps.length > 0) {
		introJs().setOptions({
		  steps: steps,
		  showStepNumbers: true,
		  exitOnOverlayClick: false,
		  showBullets: true,
		  nextLabel: "Siguiente",
		  prevLabel: "Anterior",
		  skipLabel: "Omitir",
		  doneLabel: "Finalizar"
		}).start();
	  }
	}
	</script>
	{% endblock %}
	

</body>
</html>