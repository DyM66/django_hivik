{% extends "got/base/base_generic.html" %}
{% load my_tags %}

{% block content %}

<div class="container">
    <h1>
        <a href="{% url 'got:asset-detail' asset.abbreviation %}"><i class="bi bi-arrow-bar-left"></i></a>
        Reporte consumos de Lubricantes, Combustibles y Filtros<br>
        {{ asset.name }}
    </h1>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <p>Último reporte realizado: {{ ultima_fecha_transaccion }}</p>
        <button type="button" class="btn btn-primary" onclick="toggleHistorial()">Ver Historial</button>
    </div>

    {% if perms.got.add_transaccionsuministro %}
        <form method="post">{% csrf_token %}

            <div class="form-group">
                <label for="fecha_reporte">Fecha del Reporte</label>
                <input type="date" id="fecha_reporte" name="fecha_reporte" class="form-control" value="{{ fecha_actual }}" required>
            </div>

            {% for presentacion, group in grouped_suministros.items %}
                <table class="table-list table-detail">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th>Ultima cantidad reportada</th>
                            <th>Cantidad Ingresada</th>
                            <th>Cantidad Consumida</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for suministro in group %}
                            <tr>    
                                <td>{{ suministro.item }} ({{presentacion}})</td>
                                <td>{{ suministro.cantidad }}</td>
                                <td><input class="form-control cantidad-ingresada" type="number" name="ingresado_{{ suministro.id }}" value="0.00" min="0" step="any" data-cantidad-actual="{{ suministro.cantidad }}" data-row-id="{{ suministro.id }}"></td>
                                <td><input class="form-control cantidad-consumida" type="number" name="consumido_{{ suministro.id }}" value="0.00" min="0" step="any" data-row-id="{{ suministro.id }}"></td>
                                
                                <td><span id="total_{{ suministro.id }}"> {{ suministro.cantidad }} </span></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <br>
            {% endfor %}
            <button type="submit" class="btn btn-primary submit-button">Actualizar Consumos</button>
        </form>
    {% endif %}
        
    <!-- Historial -->
    <div id="historial" style="display: none; margin-top: 20px;">
        <h2>Historial de Transacciones</h2>
        <!-- Filtros -->
        <div class="filters" style="margin-bottom: 20px;">
            <label for="filtro_presentacion">Presentación:</label>
            <select id="filtro_presentacion">
                <option value="">Todos</option>
                {% for presentacion in grouped_suministros.keys %}
                    <option value="{{ presentacion }}">{{ presentacion }}</option>
                {% endfor %}
            </select>

            <label for="filtro_articulo">Artículo:</label>
            <select id="filtro_articulo">
                <option value="">Todos</option>
                {% for article in articles %}
                    <option value="{{ article }}">{{ article }}</option>
                {% endfor %}
            </select>

            <label for="filtro_fecha_inicio">Desde:</label>
            <input type="date" id="filtro_fecha_inicio">

            <label for="filtro_fecha_fin">Hasta:</label>
            <input type="date" id="filtro_fecha_fin">

            <button type="button" class="btn btn-secondary" onclick="aplicarFiltros()">Aplicar Filtros</button>
            <form method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" name="download_excel" class="btn btn-info">Descargar Excel</button>
            </form>
        </div>

        <table id="tabla_historial" class="table-list table-detail">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th class="nowrap">Reportado por</th>
                    <th>Artículo</th>
                    <th>Presentación</th>
                    <th>Cantidad Ingresada</th>
                    <th>Cantidad Consumida</th>
                </tr>
            </thead>
            <tbody>
                {% for transaccion in transacciones_historial %}
                    <tr>
                        <td>{{ transaccion.fecha|date:"d/m/Y" }}</td>
                        <td>{{ transaccion.usuario.get_full_name }}</td>
                        <td data-item-name="{{ transaccion.suministro.item.name }}">{{ transaccion.suministro.item }}</td>
                        <td>{{ transaccion.suministro.item.presentacion }}</td>
                        <td>{{ transaccion.cantidad_ingresada }}</td>
                        <td>{{ transaccion.cantidad_consumida }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5">No hay transacciones registradas.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Función para mostrar/ocultar el historial
    function toggleHistorial() {
        const historialDiv = document.getElementById('historial');
        if (historialDiv.style.display === 'none' || historialDiv.style.display === '') {
            historialDiv.style.display = 'block';
            historialDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Lleva la vista al inicio de la tabla
        } else {
            historialDiv.style.display = 'none';
        }
    }

    // Función para actualizar el total basado en la cantidad ingresada y consumida
    function actualizarTotal(rowId) {
        const cantidadActual = parseFloat(document.querySelector(`input[name="ingresado_${rowId}"]`).getAttribute('data-cantidad-actual')) || 0;
        const cantidadIngresada = parseFloat(document.querySelector(`input[name="ingresado_${rowId}"]`).value) || 0;
        const cantidadConsumida = parseFloat(document.querySelector(`input[name="consumido_${rowId}"]`).value) || 0;

        // Calcular el nuevo total
        const total = cantidadActual + cantidadIngresada - cantidadConsumida;

        // Actualizar el valor en la columna Total
        document.getElementById(`total_${rowId}`).innerText = total.toFixed(2);
    }

    // Event listeners para los inputs de cantidad ingresada y consumida
    document.querySelectorAll('.cantidad-ingresada, .cantidad-consumida').forEach(input => {
        input.addEventListener('input', function() {
            const rowId = this.getAttribute('data-row-id');
            actualizarTotal(rowId);
        });
    });

    function aplicarFiltros() {
        const filtroPresentacion = document.getElementById('filtro_presentacion').value;
        const filtroArticulo = document.getElementById('filtro_articulo').value;
        const filtroFechaInicio = document.getElementById('filtro_fecha_inicio').value;
        const filtroFechaFin = document.getElementById('filtro_fecha_fin').value;

        const rows = document.querySelectorAll('#tabla_historial tbody tr');

        rows.forEach(row => {
            const fechaTexto = row.cells[0].innerText.trim();
            const articulo = row.querySelector('td[data-item-name]').getAttribute('data-item-name').trim();
            const presentacion = row.cells[2].innerText.trim();

            let mostrar = true;

            // Filtrar por presentación
            if (filtroPresentacion && presentacion !== filtroPresentacion) {
                mostrar = false;
            }

            // Filtrar por artículo
            if (filtroArticulo && articulo !== filtroArticulo) {
                mostrar = false;
            }

            // Filtrar por fechas
            if ((filtroFechaInicio || filtroFechaFin) && fechaTexto) {
                // Convertir fecha de la fila a objeto Date
                const partesFecha = fechaTexto.split('/');
                const dia = parseInt(partesFecha[0], 10);
                const mes = parseInt(partesFecha[1], 10) - 1; // Los meses en JavaScript son 0-indexed
                const anio = parseInt(partesFecha[2], 10);
                const fechaRow = new Date(anio, mes, dia);

                // Filtrar por fecha desde
                if (filtroFechaInicio) {
                    const fechaInicio = new Date(filtroFechaInicio);
                    if (fechaRow < fechaInicio) {
                        mostrar = false;
                    }
                }

                // Filtrar por fecha hasta
                if (filtroFechaFin) {
                    const fechaFin = new Date(filtroFechaFin);
                    if (fechaRow > fechaFin) {
                        mostrar = false;
                    }
                }
            }

            // Mostrar u ocultar la fila
            row.style.display = mostrar ? '' : 'none';
        });
    }

</script>

{% endblock %}