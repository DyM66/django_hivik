{% extends "got/base_generic.html" %}

{% block head %}
<a href="{% url 'got:asset-detail' system.asset.id %}"><i class="bi bi-arrow-90deg-left"></i></a>
{{ system.asset }}/{{ system.name }}
{% endblock %}

{% block content %}

<div class="container">
    <button type="button" class="btn btn-primary space" data-bs-toggle="modal" data-bs-target="#comModal">
        Crear nuevo componente
    </button>
</div>

<!-- Equipos -->
{% if system.equipos.all %}
<section class="container mt-4">

<div class="row">
{% for equipo in system.equipos.all %}
    	<!-- Repite la estructura para más equipos -->
		<div class="col-md-4">
			<div class="card" style="width: 25rem;">
				{% if equipo.imagen %}
				<img src="{{ equipo.imagen.url }}" class="card-img-top" alt="Imagen del Equipo">
				{% endif %}
				<div class="card-body">
			  		<h2 class="card-title">{{equipo.name}}</h2>
			  		<p class="card-text"><strong>Especificaciones:</strong> {{equipo.feature}}</p>
				</div>
				<ul class="list-group list-group-flush">
			  		<li class="list-group-item"><strong>Modelo:</strong>  {{equipo.model}}</li>
			  		<li class="list-group-item"><strong>Marca:</strong>  {{equipo.marca}}</li>
			  		<li class="list-group-item"><strong>Serial:</strong> {{equipo.serial}}</li>
			  		<li class="list-group-item"><strong>Fecha ingreso al inventario:</strong> {{equipo.date_inv}}</li>
			  		<li class="list-group-item"><strong>codigo interno:</strong> {{equipo.code}}</li>
			  		<li class="list-group-item"><strong>Estado:</strong> {{system.get_state_display}}</li>
			  		<li class="list-group-item"><strong>Fabricante:</strong> {{equipo.fabricante}}</li>
				</ul>
				<div class="card-body">
					{% if equipo.manual_pdf %}
					<a href="{{ equipo.manual_pdf.url }}" class="card-link">Ver manual</a>
					{% endif %}
					<a href="{% url 'got:equipo-delete' equipo.code %}" class="card-link"><i class="bi bi-file-earmark-minus-fill"></i></a>
					<a href="{% url 'got:equipo-update' equipo.code %}" class="card-link"><i class="bi bi-pen"></i></a>
				</div>
		  	</div>
		</div>
{% endfor %}
</div>
</section>



{% else %}
	<section class="container mt-5">
		<p>No hay equipos registrados.</p>
	</section>
{% endif %}

<!-- Rutinas -->
<section class="container mt-5">
	<div>
		<h2>Rutinas de mantenimiento</h2>
		<a href="{% url 'got:ruta-create' system.id %}" class="btn btn-secondary">Crear nueva rutina</a>
	
		{% if system.rutas.all %}
			<table class="table table-striped">
				<thead>
					<tr>
						<th scope="col">Codigo</th>
						<th scope="col">Frecuencia (días)</th>
						<th scope="col">Fecha de ultima intervención</th>
						<th scope="col">Fecha proxima intervención</th>
						<th scope="col">Acciones</th>
					</tr>
				</thead>
				<tbody>
					{% for ruta in system.rutas.all %}
					<tr data-bs-toggle="collapse" data-bs-target="#collapse{{ ruta.code }}" aria-expanded="false" aria-controls="collapse{{ ruta.code }}" class="{% if ruta.maintenance_status == 'c' %}table-success{%elif ruta.maintenance_status == 'p' %}table-warning{% else %}table-danger{% endif %}">
						<th scope="row">{{ ruta.name }}</th>
						<td>{{ ruta.frecuency }}</td>
						<td>{{ ruta.intervention_date }}</td>
						<td>{{ ruta.next_date }}</td>
						<td>
							<a class="btn btn-secondary btn-sm" href="{% url 'got:ruta-update' ruta.code %}"><i class="bi bi-pen"></i></a>
							<a class="btn btn-outline-danger btn-sm" href="{% url 'got:ruta-delete' ruta.code %}"><i class="bi bi-file-earmark-minus-fill"></i></a>
						</td>
					</tr>
					<tr>
						<td colspan="5">
							<div id="collapse{{ ruta.code }}" class="collapse">
								<h3>Actividades:</h3>
								<a href="{% url 'got:task-create' ruta.code %}" class="btn btn-secondary"><i class="bi bi-clipboard2-plus-fill"></i></a>

								{% if ruta.task_set.all %}
								<ol>
									{% for task in ruta.task_set.all %}
										<li>{{ task.description }} <a href="{% url 'got:task-delete' task.id %}"><i class="bi bi-file-earmark-minus-fill"></i></a></li>
										<ul style="list-style-type: none;">
											<li>{{ task.responsible.first_name }} {{ task.responsible.last_name }}</li>
											<li>{{ task.news }}</li>
										</ul>
									{% endfor %}
								</ol>
								{% else %}
									<p>No hay actividades registradas.</p>
								{% endif %}
							</div>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		{% else %}
			<p>No hay rutinas registradas.</p>
		{% endif %}
	</div>
</section>

	
<!-- Formulario modal para Componentes -->
<div class="modal fade" id="comModal" tabindex="-1" aria-labelledby="comModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      	<div class="modal-content">
        	<div class="modal-header">
          		<h5 class="modal-title" id="comModalLabel">Crear nuevo componente</h5>
          		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        	</div>
        	<div class="modal-body">
          		<form method="post" action="" enctype="multipart/form-data">{% csrf_token %}
            		<table>
              			{{ equipo_form.as_table }}
            		</table>
            		<button type="submit" class="btn btn-primary">Agregar</button>
          		</form>
        	</div>
    	</div>
    </div>
</div>


{% endblock %}