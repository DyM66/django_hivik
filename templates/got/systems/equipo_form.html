<!-- got/templates/got/systems/equipo_form.html -->
{% extends "got/base/base_generic.html" %}

{% block headtag %}
    {% include "got/systems/equipo_form_styles.html" %}
{% endblock %}
{% block content %}
<div class="container mt-4" style="font-size:0.9rem;">

    <h2 class="mb-3">
        {% if object %}
            Editar Equipo - <strong>{{ object.system }}</strong>
        {% else %}
            Crear Equipo - <strong>{{ sys }}</strong>
        {% endif %}
    </h2>
    <hr>

    <form action="" method="post" enctype="multipart/form-data" class="adap p-4">{% csrf_token %}
        <input type="hidden" name="next_to" value="{{ next_to }}">
        <div class="row">
            <!-- Primera Columna: Campos Básicos -->
            <div class="col-md-6">
                <h4>Información Básica</h4>
                <div class="mb-2">
                    {{ form.name.label_tag }}
                    {{ form.name }}
                </div>
                <div class="mb-2">
                    {{ form.model.label_tag }}
                    {{ form.model }}
                </div>
                <div class="mb-2">
                    {{ form.serial.label_tag }}
                    {{ form.serial }}
                </div>
                <div class="mb-2">
                    {{ form.marca.label_tag }}
                    {{ form.marca }}
                </div>
                <div class="mb-2">
                    {{ form.fabricante.label_tag }}
                    {{ form.fabricante }}
                </div>
                <div class="mb-2">
                    {{ form.tipo.label_tag }}
                    {{ form.tipo }}
                </div>
                <div class="mb-2">
                    {{ form.estado.label_tag }}
                    {{ form.estado }}
                </div>
                <div class="mb-2">
                    {{ form.critico.label_tag }}
                    {{ form.critico }}
                </div>
                <div class="mb-2">
                    {{ form.feature.label_tag }}
                    {{ form.feature }}
                </div>
                <div class="mb-2">
                    {{ form.recomendaciones.label_tag }}
                    {{ form.recomendaciones }}
                </div>
            </div>

            <!-- Segunda Columna: Campos Adicionales -->
            <div class="col-md-6">
                <h4>Información Adicional</h4>
                <div class="mb-3">
                    <label for="{{ form.related.id_for_label }}">
                        {{ form.related.label }}
                        <small class="form-text text-muted">{{ form.related.help_text }}</small>
                    </label>
                    {{ form.related }}
                </div>
                <div class="mb-3">
                    {{ form.ubicacion.label_tag }}
                    {{ form.ubicacion }}
                </div>


                <!-- Bloque donde se muestran las imágenes -->
                <div id="image-list">
                    <h5>Imágenes asociadas {% if object %}({{ image_count }}){% endif %}</h5>
                    <!-- Widget de Subida de Imágenes -->
                    <div class="mb-3">
                        {{ upload_form }}  
                    </div>
                    {% if object %} 
                        <div class="row">
                            {% for image in object.images.all %}
                                <div class="col-md-3" id="image-{{ image.id }}">
                                    <div class="image-wrapper">
                                        <img src="{{ image.image.url }}" class="img-thumbnail" alt="Imagen del equipo">
                                        <!-- Botón "X" para eliminar; se usa type="button" para que no dispare submit -->
                                        <button type="button" class="delete-image-btn" data-image-id="{{ image.id }}" title="Eliminar imagen">
                                            &times;
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <script>
                            document.addEventListener("DOMContentLoaded", function(){
                                // Agregar listener a los botones de eliminación
                                const deleteButtons = document.querySelectorAll('.delete-image-btn');
                                deleteButtons.forEach(function(button) {
                                    button.addEventListener('click', function(event){
                                        event.preventDefault(); // Prevenir comportamiento por defecto
                                        const imageId = this.getAttribute('data-image-id');
                                        // Realiza la petición AJAX a la vista EquipoDeleteImageView
                                        fetch("{% url 'got:equipo-delete-image' object.pk %}", {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/x-www-form-urlencoded",
                                                "X-CSRFToken": "{{ csrf_token }}"
                                            },
                                            body: "image_id=" + imageId
                                        })
                                        .then(response => response.json()).then(data => {
                                            if(data.success){
                                                // Elimina el contenedor de la imagen en el DOM
                                                const imageDiv = document.getElementById("image-" + imageId);
                                                if(imageDiv){
                                                    imageDiv.remove();
                                                }
                                                // Actualiza el contador de imágenes
                                                const header = document.querySelector("#image-list h5");
                                                header.textContent = "Imágenes asociadas (" + data.image_count + ")";
                                            } else {
                                                alert("Error: " + (data.error || "No se pudo eliminar la imagen."));
                                            }
                                        })
                                        .catch(error => console.error("Error en la eliminación de la imagen:", error));
                                    });
                                });
                            });
                            </script>
                    {% endif %}
                </div>


                <!-- Campo para Subir Manual PDF -->
                <div class="mb-3">
                    {{ form.manual_pdf.label_tag }}
                    {{ form.manual_pdf }}
                </div>

                <!-- Sección Opcional para Motores -->
                <div class="mb-3">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#motor-section" aria-expanded="false" aria-controls="motor-section">
                        {{ form.potencia.label }} y Horas (Opcional)
                    </button>
                    <div class="collapse mt-2" id="motor-section">
                        <div class="mb-3">
                            {{ form.potencia.label_tag }}
                            {{ form.potencia }}
                        </div>
                        <div class="mb-3">
                            {{ form.initial_hours.label_tag }}
                            {{ form.initial_hours }}
                        </div>
                    </div>
                </div>

                <!-- Sección Opcional para Tanques -->
                <div class="mb-3">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#tanque-section" aria-expanded="false" aria-controls="tanque-section">
                        Información de Tanques (Opcional)
                    </button>
                    <div class="collapse mt-2" id="tanque-section">
                        <div class="mb-3">
                            {{ form.tipo_almacenamiento.label_tag }}
                            {{ form.tipo_almacenamiento }}
                        </div>
                        <div class="mb-3">
                            {{ form.volumen.label_tag }}
                            {{ form.volumen }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón de Guardar -->
        <button type="submit" class="btn btn-primary">Guardar</button>
    </form>
</div>

{% endblock %}