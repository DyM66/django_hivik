{% extends "got/base_generic.html" %}
{% load my_tags %}


{% block headtag %}

<style>
    .btn-group-toggle {
        display: flex;
        gap: 10px;
    }

    .btn-group-toggle label {
        background-color: #f8f9fa;
        color: #495057;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .btn-group-toggle label:hover {
        background-color: #e9ecef;
    }

    .btn-group-toggle input[type="radio"]:checked + label {
        background-color: #007bff;
        color: white;
    }

    legend {
        font-size: 16px;
    }

    
    @media (width> 650px) {
	
        .adap {
            width: 50%;
            border: 0.4px #666 solid;
            border-radius: 10px;
            padding: 2rem;
            margin: auto;
        }
	}
</style>
{% endblock %}

{% block header %}
    <a href="{% url 'got:ot-list' %}"><i class="bi bi-arrow-90deg-left"></i></a>
    Detalle de OT-{{ot.num_ot}}
{% endblock %} 

{% block content %}

<div class="container">

<section>
    <!-- Existen actividades -->
    {% if ot.task_set.all %} 
        <!-- Estan finalizadas esas actividades -->
        {% if all_tasks_finished %}
            <!-- Se encuentra en estado de ejecucion -->
            {% if ot.state == 'x' %}
                <form method="post" action="{% url 'got:ot-detail' ot.num_ot %}">{% csrf_token %}
                    {{ state_form.as_p }}
                    <button type="submit" class="btn btn-primary" name="finish_ot">Finalizar</button>
                </form>
            {% endif %}
        {% endif %}
    {% endif %}
</section>


<!-- Informacion basica -->
<table class="table">
    <tbody>
        <tr>
            <th>Fecha: </th>
            <td>{{ot.creation_date}}</td>
        </tr>
        <tr>
            <th>Supervisor: </th>
            <td>{{ot.super.first_name}} {{ot.super.last_name}}</td>
        </tr>
        <tr>
            <th>Estado: </th>
            <td>{{ot.get_state_display}}</td>
        </tr>
        <tr>
            <th>Sistema: </th>
            <td>{{ot.system}}</td>
        </tr>    
        <tr>
            <th>Descripción: </th>
            <td>{{ot.description}}</td>
        </tr>
        <tr>
            <th>Tipo de mantenimiento: </th>
            <td>{{ot.get_tipo_mtto_display}}</td>
        </tr>
        {% if ot.info_contratista_pdf %}
            <tr>
                <th>Informe externo: </th>
                <td><a href="{{ ot.info_contratista_pdf.url }}" target="_blank">Ver PDF</a></td>
            </tr>
        {% endif %}
        {% if ot.ot_aprobada %}
            <tr>
                <th>Orden recibida: </th>
                <td><a href="{{ ot.ot_aprobada.url }}" target="_blank">Ver PDF</a></td>
            </tr>
        {% endif %}
    </tbody>
</table>

{% if failure_report %}
    <section>
        <h4>Reporte de Falla Relacionado</h4>
        <a href="{% url 'got:failure-report-detail' failure_report.pk %}">
            Ver Reporte de Falla #{{ failure_report.pk }}
        </a>
    </section>
{% endif %}

{% if ruta_id %}
    <section>
        <h4>Rutina de mantenimiento</h4>
        <a href="{% url 'got:sys-detail' ot.system.pk %}">
            Ver ruta de mantenimiento {{ ruta_id.name }}
        </a>
    </section>
{% endif %}


<!---------------------------------------- Opciones (generar reportte/ actualizar/ Eliminar) ---------------------------------------->

    <section class="d-flex justify-content-end">
        <div class="btn-group">
            <a href="{% url 'got:report' ot.num_ot %}" target="_blank" class="btn btn-outline-primary" aria-current="page">Imprimir detalle</a>
            <a href="{% url 'got:ot-update' ot.num_ot %}" class="btn btn-outline-primary">Actualizar</a>
            <a href="{% url 'got:ot-delete' ot.num_ot %}" class="btn {% if has_activities %}btn-danger disabled{% else %}btn-danger{% endif %}">Eliminar</a>
        </div>
    </section>

<!------------------------------------------------ Actividades de ordenes de trabajo ------------------------------------------------>
<section>

    <h4>Actividades</h4>

        {% if ot.state == 'x' %}
            <button type="button" class="btn btn-primary space" data-bs-toggle="modal" data-bs-target="#activityModal">
                Crear Actividad
            </button>
        {% endif %}


    {% if ot.task_set.all %}
        <table class="table table-striped mt-2">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Descripción</th>
                    <th scope="col">Novedades</th>
                    <th scope="col">Responsable</th>
                    <th scope="col">Estado</th>
                    <th scope="col">Fechas</th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>

            <tbody>
                {% for act in ot.task_set.all %}
                    <tr>
                        <th scope="row">{{forloop.counter}}</th>
                        <td><a href="{% url 'got:finish-task' act.id %}"> {{ act.description }}</a></td>
                        <td>{{ act.news }}</td>
                        <td>{{act.responsible.first_name}} {{act.responsible.last_name}}</td>
                        <td>{% if act.finished %}Completado{%else%}Pendiente{% endif %}</td>
                        <td>{{act.start_date|date:"d/m/Y"}}-{{act.final_date|date:"d/m/Y"}}</td>
                        {% if not request.user|has_group:"serport_members" %}
                            <td>
                                <a class="" href="{% url 'got:task-update' act.id %}"><i class="bi bi-pen"></i></a>
                                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#delete{{ act.id }}">
                                    <i class="bi bi-file-earmark-minus-fill"></i>
                                </button>
                            </td>

                            <!-- Modal para la creación de OT -->
                            <div class="modal fade" id="delete{{ act.id }}" tabindex="-1" aria-labelledby="deleteLabel{{ act.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="deleteLabel{{ act.id }}">Eliminar actividad: </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            {{act.description}}
                                        </div>
                                        <div class="modal-footer">
                                            <form method="post" action="{% url 'got:ot-detail' ot.num_ot %}" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <input type="hidden" name="delete_task_id" value="{{ act.id }}">
                                                <button type="submit" class="btn btn-danger" name="delete_task">Eliminar</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    {% else %}
        <p>No hay actividades registradas.</p>
    {% endif %}
</section>
<!--------------------------------------------- Fin de actividades de ordenes de trabajo ----------------------------->

<!--------------------------------------------- modal para crear actividades ----------------------------------------->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityModalLabel">Crear Actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{{ ot.get_absolute_url }}" enctype="multipart/form-data">{% csrf_token %}
                    <div class="form-group">
                        {{ task_form }}
                        {{ image_form }}
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" name="submit_task">Agregar Actividad</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


{% endblock %}