<!-- permission_matrix.html -->
{% extends 'base/base_generic.html' %}
{% load custom_filters %} 

{% block title %}Gestión de Permisos{% endblock %}

{% block headtag %}
<style>
    .container-table{
        overflow-x: auto;
    }
    ::-webkit-scrollbar {
        width: 10px;
    }
    /* Track */
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        box-shadow: inset 0 0 5px grey;
        border-radius: 10px;
    }
    
    /* Handle */
    ::-webkit-scrollbar-thumb {
        background: rgb(100, 100, 100);
        border-radius: 10px;
    }
    
    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
        background: rgb(80, 80, 80);
    }
    table.permissions-table {
        border-collapse: collapse;
        width: 100%;
        font-size: 0.8rem;
    }
    .permissions-table th, 
    .permissions-table td {
        border: 1px solid #ccc;
        padding: 4px 6px;
        text-align: center;
    }
    .header-app {
        background-color: #006699;
        color: #fff;
        font-weight: bold;
    }
    .header-model {
        background-color: #0099cc;
        color: #fff;
    }
    .header-permission {
        background-color: #33ccff;
        color: #fff;
    }
    .group-row {
        background-color: #e8e8e8;
        font-weight: bold;
    }
    .has-permission {
        background-color: #b3ffb3;
        cursor: pointer;
    }
    .no-permission {
        background-color: #f2f2f2;
        cursor: pointer;
    }
    td.username-cell {
        text-align: left;
        font-weight: normal;
        background-color: #fffaf0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Administrar Permisos</h2>
    <p class="text-muted">Haz click en una celda para asignar/quitar el permiso.</p>

    <div class="container-table">
        <table class="permissions-table">
            <thead>
                <!-- 1) Fila de Apps -->
                <!-- Fila 1: Apps -->
                <tr>
                    <th rowspan="3">Grupo/Usuario</th>
                    {% for app in apps_data %}
                        <th class="header-app" colspan="{{ app.colspan }}">
                            {{ app.app_label|upper }}
                        </th>
                    {% endfor %}
                </tr>
                <!-- Fila 2: Models -->
                <tr>
                    {% for app in apps_data %}
                        {% for model_info in app.models %}
                            <th class="header-model" colspan="{{ model_info.num_perms }}">
                                {{ model_info.model_label|capfirst }}
                            </th>
                        {% endfor %}
                    {% endfor %}
                </tr>
                <!-- Fila 3: Perms -->
                <tr>
                    {% for app in apps_data %}
                        {% for model_info in app.models %}
                            {% for perm in model_info.perms %}
                                <th class="header-permission">
                                    {{ perm.codename|split:"_"|first|capfirst }}
                                </th>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                </tr>
            </thead>
    
            <tbody>
                {# 1 Filas de grupos #}
                {% for group in groups %}
                    <!-- Fila del grupo mismo -->
                    <tr class="group-row">
                        <td>{{ group.name }}</td>
                        {% for app_label, models_dict in permission_structure.items %}
                            {% for model_label, perms in models_dict.items %}
                                {% for p in perms %}
                                    {% if p in group.permissions.all %}
                                        <td class="has-permission" 
                                            data-object-type="group"
                                            data-object-id="{{ group.id }}"
                                            data-perm-id="{{ p.id }}">X</td>
                                    {% else %}
                                        <td class="no-permission"
                                            data-object-type="group"
                                            data-object-id="{{ group.id }}"
                                            data-perm-id="{{ p.id }}"></td>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
    
                    {# Filas de usuarios en este grupo #}
                    {% for user in users %}
                        {% if group in user.groups.all %}
                            <tr>
                                <td class="username-cell">{{ user.username }}</td>
                                {% for app_label, models_dict in permission_structure.items %}
                                    {% for model_label, perms in models_dict.items %}
                                        {% for p in perms %}
                                            {% if user|has_permission:p %}
                                                <td class="has-permission"
                                                    data-object-type="user"
                                                    data-object-id="{{ user.id }}"
                                                    data-perm-id="{{ p.id }}">X</td>
                                            {% else %}
                                                <td class="no-permission"
                                                    data-object-type="user"
                                                    data-object-id="{{ user.id }}"
                                                    data-perm-id="{{ p.id }}"></td>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            </tr>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
    
            </tbody>
        </table>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table.permissions-table');
    // Delegamos el click a todas las celdas con data-perm-id
    table.addEventListener('click', function(e) {
        const cell = e.target.closest('td[data-perm-id]');
        if (!cell) return; // no es una celda de permiso

        const permId = cell.dataset.permId;
        const objType = cell.dataset.objectType; // "group" o "user"
        const objId = cell.dataset.objectId;
        
        // Realizar AJAX con fetch a un endpoint toggle
        fetch("{% url 'permissions_dashboard:toggle-permission' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                'permission_id': permId,
                'object_type': objType,
                'object_id': objId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cambiar visualmente la celda
                if (cell.classList.contains('has-permission')) {
                    cell.classList.remove('has-permission');
                    cell.classList.add('no-permission');
                    cell.textContent = '';
                } else {
                    cell.classList.remove('no-permission');
                    cell.classList.add('has-permission');
                    cell.textContent = 'X';
                }
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error en la petición AJAX.");
        });
    });
});
</script>
{% endblock %}
